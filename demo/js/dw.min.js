/*! dw-html5 20150711 */
function init(a,b){"use strict";game=new dw.DwGame({parent:a,scale:SCALE,width:CANVAS_WIDTH,height:CANVAS_HEIGHT,assetRoot:b,targetFps:60}),game.setState(new dw.LoadingState),game.start()}function innkeeperConversationTemplate(a,b){"use strict";return[{clear:!1,text:"Welcome to the inn.  Our price is "+b.cost+" gold per night.  Wilst thou stay?",afterSound:"confirmation",choices:[{text:"Yes",next:"stay"},{text:"No",next:"leave"}]},{id:"stay",text:"Have a good night!",overnight:!0},{text:"I hope you had a good night.",action:function(){game.party.replenishHealthAndMagic(),game.party.gold-=b.cost}},{text:"I shall see thee again.",next:"_done"},{id:"leave",text:"I shall see thee again."}]}function merchantConversationTemplate(a,b){"use strict";return[{clear:!1,text:b.introText||"Welcome! Would you like to see our wares?",afterSound:"confirmation",choices:[{text:"Yes",next:dw.Conversation.CHOICES_SEGMENT},{text:"No",next:dw.Conversation.BID_FAREWELL_SEGMENT}]},{id:dw.Conversation.CHOICES_SEGMENT,text:"What dost thou wish to buy?",shopping:{choices:b.choices}},{id:dw.Conversation.CONFIRM_SEGMENT,text:"The \\w{item.name}? That will be \\w{item.baseCost} gold.  Is that okay?",afterSound:"confirmation",choices:[{text:"Yes",next:dw.Conversation.PURCHASE_SEGMENT},{text:"No",next:dw.Conversation.CHOICES_SEGMENT}]},{id:dw.Conversation.PURCHASE_SEGMENT,action:function(){game.party.addInventoryItem(a.item),game.party.gold-=a.item.baseCost},text:"I thank thee!",next:dw.Conversation.SOMETHING_ELSE_SEGMENT},{id:dw.Conversation.NOT_ENOUGH_SEGMENT,text:"I'm afraid you do not have enough gold!"},{id:dw.Conversation.SOMETHING_ELSE_SEGMENT,text:"Would you like to buy something else?",afterSound:"confirmation",choices:[{text:"Yes",next:dw.Conversation.CHOICES_SEGMENT},{text:"No",next:dw.Conversation.BID_FAREWELL_SEGMENT}]},{id:dw.Conversation.BID_FAREWELL_SEGMENT,text:"Please, come again."}]}function Brecconary(){}function Overworld(){}function TantegelCastle(){}var SCALE=2,tileSize=16*SCALE,CANVAS_WIDTH=17*tileSize,CANVAS_HEIGHT=15*tileSize,game,dw={},gtp=gtp||{};gtp.Utils=function(){},gtp.Utils.getObjectSize=function(a){"use strict";var b=0;for(var c in a)a.hasOwnProperty(c)&&b++;return b},gtp.Utils.getRequestParam=function(a){"use strict";var b,c,d=a,e=window.location.search.substring(1);if(0===e.indexOf(d))return b=e.indexOf("="),-1===b?"":(b++,c=Math.max(e.indexOf("&",b),e.length),e.substring(b,c));d="&"+d;var f=e.indexOf(d);if(f>=-1){var g=f+d.length;if("="===e.charAt(g))return g++,c=Math.max(e.indexOf("&",g),e.length),e.substring(g,c);if(g===e.length)return""}return null},gtp.Utils.hitch=function(a,b){"use strict";return function(){b.apply(a,arguments)}},gtp.Utils.mixin=function(a,b){"use strict";for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c])},gtp.Utils.randomInt=function(a,b){"use strict";return b||(b=a,a=0),Math.floor(Math.random()*(b-a))+a},gtp.Utils.initConsole=function(){"use strict";if(!window.console){var a=function(){};window.console={log:a,warn:a,error:a}}};var gtp=gtp||{};gtp.ImageUtils=function(){},gtp.ImageUtils.resize=function(a,b){"use strict";var c,d;if("img"===a.nodeName.toLowerCase()?(c=gtp.ImageUtils.createCanvas(a.width,a.height),d=c.getContext("2d"),d.drawImage(a,0,0)):(c=a,d=c.getContext("2d")),1===b)return c;for(var e=d.getImageData(0,0,a.width,a.height),f=a.width*b,g=a.height*b,h=gtp.ImageUtils.createCanvas(f,g),i=h.getContext("2d"),j=i.getImageData(0,0,f,g),k=0;g>k;k++)for(var l=0;f>l;l++){var m=4*(Math.floor(k/b)*a.width+Math.floor(l/b)),n=4*(k*f+l);j.data[n]=e.data[m],j.data[n+1]=e.data[m+1],j.data[n+2]=e.data[m+2],j.data[n+3]=e.data[m+3]}return i.putImageData(j,0,0),h},gtp.ImageUtils.createCanvas=function(a,b,c){"use strict";var d=document.createElement("canvas");return d.width=a,d.height=b,gtp.ImageUtils.prepCanvas(d),c&&("string"==typeof c&&(c=document.getElementById(c)),c.innerHTML="",c.appendChild(d)),d},gtp.ImageUtils.prepCanvas=function(a){"use strict";var b=a.getContext("2d");b.imageSmoothingEnabled=!1,b.mozImageSmoothingEnabled=!1,b.oImageSmoothingEnabled=!1,b.webkitImageSmoothingEnabled=!1,b.msImageSmoothingEnabled=!1},gtp.ImageUtils.makeColorTranslucent=function(a,b,c){"use strict";b=b||0,c=c||0;for(var d=a.getContext("2d"),e=a.width,f=a.height,g=d.getImageData(0,0,e,f),h=[],i=4*(c*e+b),j=0;4>j;j++)h[j]=g.data[i+j];for(c=0;f>c;c++)for(b=0;e>b;b++){var k=4*(c*e+b);g.data[k]===h[0]&&g.data[k+1]===h[1]&&g.data[k+2]===h[2]&&g.data[k+3]===h[3]&&(g.data[k]=0,g.data[k+1]=0,g.data[k+2]=0,g.data[k+3]=0)}return d.putImageData(g,0,0),a};var gtp=gtp||{};gtp.Timer=function(){"use strict";this._startTimes=[],this._prefix="DEBUG"},gtp.Timer.prototype={setLogPrefix:function(a){"use strict";this._prefix=a||"DEBUG"},start:function(a){"use strict";this._startTimes[a]=(new Date).getTime()},end:function(a){"use strict";var b=this._startTimes[a];if(!b)return console.error('Cannot end timer for "'+a+'" as it was never started'),-1;var c=(new Date).getTime()-b;return delete this._startTimes[a],c},endAndLog:function(a){"use strict";var b=this.end(a);b>-1&&console.log(this._prefix+": "+a+": "+b+" ms")}};var gtp=gtp||{};gtp.Delay=function(a){"use strict";if(!a||!a.millis)throw'Missing required "millis" argument to gtp.Delay';this._initial=a.millis.length?a.millis:[a.millis],this._initialIndex=0,a.minDelta&&a.maxDelta&&this.setRandomDelta(a.minDelta,a.maxDelta),this._callback=a.callback,this.reset()},gtp.Delay.prototype={update:function(a){"use strict";return this._remaining>0&&(this._remaining=Math.max(this._remaining-a,0),this._remaining<=0&&this._callback&&this._callback(this)),this.isDone()},getRemaining:function(){"use strict";return this._remaining},getRemainingPercent:function(){"use strict";return this._remaining/this._curInitial},isDone:function(){"use strict";return this._remaining<=0},setRandomDelta:function(a,b){"use strict";this._minDelta=a,this._maxDelta=b},reset:function(){"use strict";this._curInitial=this._remaining=this._initial[this._initialIndex],this._initialIndex=(this._initialIndex+1)%this._initial.length,(this._minDelta||this._maxDelta)&&(this._remaining+=gtp.Utils.randomInt(this._minDelta,this._maxDelta))},toString:function(){"use strict";return"[gtp.Delay: _initial="+this._initial+", _remaining="+this._remaining+", _callback="+(null!=this._callback)+"]"}};var gtp=gtp||{};gtp.Image=function(a,b,c,d,e){"use strict";this._canvas=a,null!=b&&null!=c&&null!=d&&null!=e?(this.x=b,this.y=c,this._width=d,this._height=e):(this.x=this.y=0,this._width=this._canvas.width,this._height=this._canvas.height),this._ensure256Square()},gtp.Image.prototype={_ensure256Square:function(){"use strict";if(this._canvas.width<256||this._canvas.height<256){var a=Math.max(256,this._canvas.width),b=Math.max(256,this._canvas.height),c=gtp.ImageUtils.createCanvas(a,b),d=c.getContext("2d");d.drawImage(this._canvas,0,0),this._canvas=c}},draw:function(a,b,c){"use strict";a.drawImage(this._canvas,this.x,this.y,this._width,this._height,b,c,this._width,this._height)},drawScaled:function(a,b,c,d,e){"use strict";a.drawImage(this._canvas,this.x,this.y,this._width,this._height,b,c,d,e)},drawScaled2:function(a,b,c,d,e,f,g,h,i){"use strict";b=this.x+b,c=this.y+c,a.drawImage(this._canvas,b,c,d,e,f,g,h,i)},makeColorTranslucent:function(a,b){"use strict";gtp.ImageUtils.makeColorTranslucent(this._canvas,a,b)},get width(){"use strict";return this._width},get height(){"use strict";return this._height}};var gtp=gtp||{};gtp.ImageAtlas=function(a){"use strict";this._atlasInfo=a.atlasInfo,this._masterCanvas=a.canvas,this._atlasInfo.firstPixelIsTranslucent&&(this._masterCanvas=gtp.ImageUtils.makeColorTranslucent(this._masterCanvas))},gtp.ImageAtlas.prototype={parse:function(){"use strict";var a={},b=this;return this._atlasInfo.images.forEach(function(c){var d,e=c.id;if(c.dim){if(d=c.dim.split(/,\s*/),4!==d.length)throw new Error("Invalid value for imgInfo.dim: "+c.dim)}else d=[],d.push(c.x,c.y,c.w,c.h);d=d.map(function(a){return 2*parseInt(a,10)}),a[e]=new gtp.Image(b._masterCanvas,d[0],d[1],d[2],d[3])}),a}};var gtp=gtp||{};gtp.AudioSystem=function(){"use strict";this._currentMusic=null,this._sounds={},this._musicFade=.3,this._fadeMusic=!0,this._muted=!1},gtp.AudioSystem.prototype={init:function(){"use strict";try{window.AudioContext=window.AudioContext||window.webkitAudioContext,this.context=new window.AudioContext,this._volumeFaderGain=this.context.createGain(),this._volumeFaderGain.gain.setValueAtTime(1,this.context.currentTime),this._volumeFaderGain.gain.value=1,this._volumeFaderGain.connect(this.context.destination),this._initialized=!0}catch(a){console.error("The Web Audio API is not supported in this browser."),this._initialized=!1}},addSound:function(a){"use strict";this.context&&(this._sounds[a.id]=a)},fadeOutMusic:function(a){"use strict";if(this.context)if(this._currentMusic){this._muted||(this._musicFaderGain.gain.setValueAtTime(this._musicFaderGain.gain.value,this.context.currentTime),this._musicFaderGain.gain.linearRampToValueAtTime(0,this.context.currentTime+this._musicFade));var b=this;setTimeout(function(){b.playMusic(a)},1e3*this._musicFade)}else this.playMusic(a)},getCurrentMusic:function(){"use strict";return this.currentMusicId},isInitialized:function(){"use strict";return this._initialized},playMusic:function(a,b){"use strict";if(this.context){var c=this._sounds[a];"undefined"==typeof b&&(b=c.loopsByDefaultIfMusic),this._currentMusic&&(this._currentMusic.stop(),this._currentMusic.disconnect(),delete this._currentMusic,this._musicFaderGain.disconnect(),delete this._musicFaderGain),this._musicFaderGain=this.context.createGain(),this._musicFaderGain.gain.setValueAtTime(1,this.context.currentTime),this._musicFaderGain.gain.value=1,this._currentMusic=this.context.createBufferSource(),this._currentMusic.loop=b,this._musicLoopStart=c.loopStart||0,this._currentMusic.loopStart=this._musicLoopStart,this._currentMusic.buffer=c.buffer,this._currentMusic.loopEnd=this._currentMusic.buffer.duration,this._currentMusic.connect(this._musicFaderGain),this._musicFaderGain.connect(this._volumeFaderGain),this._currentMusic.start(0),this.currentMusicId=a,console.log("Just started new music with id: "+a+", loop: "+b)}},playSound:function(a){"use strict";if(this.context){var b=this.context.createBufferSource();b.buffer=this._sounds[a].buffer,b.connect(this._volumeFaderGain),b.start(0)}},toggleMuted:function(){"use strict";if(this._muted=!this._muted,this.context){var a=this._muted?0:1;this._volumeFaderGain.gain.setValueAtTime(a,this.context.currentTime),this._volumeFaderGain.gain.value=a}return this._muted},get fadeMusic(){"use strict";return this._fadeMusic},set fadeMusic(a){"use strict";this._fadeMusic=a||!1},get musicFadeSeconds(){"use strict";return this._musicFade},set musicFadeSeconds(a){"use strict";this._musicFade=a}};var gtp=gtp||{};gtp.AssetType=Object.freeze({UNKNOWN:0,IMAGE:1,AUDIO:2,JSON:3});var gtp=gtp||{};gtp.AssetLoader=function(a,b,c){"use strict";this._scale=a||1,this.loadingAssetData={},this.responses={},this.callback=null,this.audio=b,this._assetRoot=c},gtp.AssetLoader.prototype={addJson:function(a,b){"use strict";if(b=b||a,this._assetRoot&&(b=this._assetRoot+b),!this._isAlreadyTracked(a)){this.loadingAssetData[a]={type:gtp.AssetType.JSON},console.log("Adding: "+a+" => "+b+", remaining == "+gtp.Utils.getObjectSize(this.loadingAssetData)+", callback == "+(null!==this.callback));var c=this,d=new XMLHttpRequest;d.onreadystatechange=function(){if(4===d.readyState){var b=d.responseText;c._completed(a,b)}},d.open("GET",b,!0),d.send(null)}},addCanvas:function(a,b){"use strict";this._assetRoot&&(b=this._assetRoot+b);var c=this,d=new Image;this._isAlreadyTracked(a)||(this.loadingAssetData[a]={type:gtp.AssetType.IMAGE},console.log("Adding: "+a+" => "+b+", remaining == "+gtp.Utils.getObjectSize(this.loadingAssetData)+", callback == "+(null!==this.callback)),d.addEventListener("load",function(){var b=gtp.ImageUtils.resize(d,c._scale);c._completed(a,b)}),d.src=b)},addImage:function(a,b){"use strict";this._assetRoot&&(b=this._assetRoot+b);var c=this,d=new Image;this._isAlreadyTracked(a)||(this.loadingAssetData[a]={type:gtp.AssetType.IMAGE},console.log("Adding: "+a+" => "+b+", remaining == "+gtp.Utils.getObjectSize(this.loadingAssetData)+", callback == "+(null!==this.callback)),d.addEventListener("load",function(){var b=gtp.ImageUtils.resize(d,c._scale),e=new gtp.Image(b);c._completed(a,e)}),d.src=b)},addSound:function(a,b,c,d){"use strict";if(this.audio.isInitialized()){if(this._isAlreadyTracked(a))return;this.loadingAssetData[a]={type:gtp.AssetType.SOUND},this._assetRoot&&(b=this._assetRoot+b);var e=this,f=new XMLHttpRequest;f.onload=function(){e.audio.context.decodeAudioData(f.response,function(b){var f=new gtp.Sound(a,b,c||0);"undefined"!=typeof d&&(f.loopsByDefaultIfMusic=d),e.audio.addSound(f),e._completed(a,b)})},f.open("GET",b,!0),f.responseType="arraybuffer",f.send(null)}},addSpriteSheet:function(a,b,c,d,e,f){"use strict";var g=this;e=e||0,c*=g._scale,d*=g._scale,e*=g._scale,this._assetRoot&&(b=this._assetRoot+b);var h=new Image;this._isAlreadyTracked(a)||(this.loadingAssetData[a]={type:gtp.AssetType.IMAGE},console.log("Adding: "+a+" => "+b+", remaining == "+gtp.Utils.getObjectSize(this.loadingAssetData)+", callback == "+(null!==this.callback)),h.addEventListener("load",function(){var b=gtp.ImageUtils.resize(h,g._scale),i=new gtp.Image(b);f&&i.makeColorTranslucent(0,0);var j=new gtp.SpriteSheet(i,c,d,e);g._completed(a,j)}),h.src=b)},addTmxMap:function(a){"use strict";if(a.tilesets&&a.tilesets.length)for(var b=0;b<a.tilesets.length;b++){var c=a.tilesets[b],d="_tilesetImage_"+c.name;this.addImage(d,c.image)}},getTmxTilesetImage:function(a){"use strict";return this.responses["_tilesetImage_"+a.name]},get:function(a){"use strict";return this.responses[a]},_isAlreadyTracked:function(a){"use strict";return this.loadingAssetData[a]?(console.log("A resource with id "+a+" is already loading.  Assuming they are the same"),!0):this.responses[a]?(console.log("A resource with id "+a+" has already been loaded."),!0):void 0},set:function(a,b){"use strict";this.responses[a]=b},_completed:function(a,b){"use strict";return this.loadingAssetData[a]?(this.loadingAssetData[a].type===gtp.AssetType.JSON&&(b=JSON.parse(b)),this.responses[a]=b,delete this.loadingAssetData[a],console.log("Completed: "+a+", remaining == "+gtp.Utils.getObjectSize(this.loadingAssetData)+", callback == "+(null!==this.callback)),void(this.isDoneLoading()&&this.callback?(this.callback.call(),delete this.callback,console.log("... Callback called and deleted (callback == "+(null!==this.callback)+")"),this.nextCallback&&(this.callback=this.nextCallback,delete this.nextCallback)):console.log("... Not running callback - "+this.isDoneLoading()+", "+(null!==this.callback)))):void console.error("Resource not found! - "+a)},isDoneLoading:function(){"use strict";return 0===gtp.Utils.getObjectSize(this.loadingAssetData)},onLoad:function(a){"use strict";this.isDoneLoading()?a.call():this.callback?this.nextCallback=a:this.callback=a}};var gtp=gtp||{};gtp.SpriteSheet=function(a,b,c,d,e){"use strict";this.gtpImage=a,this.cellW=b,this.cellH=c,this.spacingX=d||1,this.spacingY=e||this.spacingX,this.rowCount=Math.floor(a.height/(c+this.spacingY)),a.height-this.rowCount*(c+this.spacingY)>=c&&this.rowCount++,this.colCount=Math.floor(a.width/(b+this.spacingX)),a.width-this.colCount*(b+this.spacingX)>=b&&this.colCount++,this.size=this.rowCount*this.colCount},gtp.SpriteSheet.prototype={drawSprite:function(a,b,c,d,e){"use strict";var f=this.cellW,g=this.cellH,h=(f+this.spacingX)*e,i=(g+this.spacingY)*d;this.gtpImage.drawScaled2(a,h,i,f,g,b,c,f,g)},drawByIndex:function(a,b,c,d){"use strict";var e=Math.floor(d/this.colCount),f=Math.floor(d%this.colCount);this.drawSprite(a,b,c,e,f)}};var gtp=gtp||{};gtp.BitmapFont=function(a,b,c,d,e){"use strict";gtp.SpriteSheet.apply(this,arguments)},gtp.BitmapFont.prototype=Object.create(gtp.SpriteSheet.prototype,{drawString:{value:function(a,b,c){"use strict";for(var d=this.size,e=game.canvas.getContext("2d"),f=this.cellW,g=0;g<a.length;g++){var h=a.charCodeAt(g)-32;(0>h||h>=d)&&(h=0),this.drawByIndex(e,b,c,h),b+=f}}}}),gtp.BitmapFont.prototype.constructor=gtp.BitmapFont;var gtp=gtp||{};gtp.InputManager=function(){"use strict";this.keys=[]},gtp.InputManager.prototype={clearKeyStates:function(){"use strict";for(var a=0;a<this.keys.length;a++)this.keys[a]=!1},down:function(a){"use strict";return this.isKeyDown(gtp.Keys.DOWN_ARROW,a)},enter:function(a){"use strict";return this.isKeyDown(gtp.Keys.ENTER,a)},install:function(){"use strict";var a=this;document.onkeydown=function(b){a._keyDown(b)},document.onkeyup=function(b){a._keyUp(b)}},_keyDown:function(a){"use strict";var b=a.keyCode;(32===b||b>=37&&40>=b)&&a.preventDefault(),this.keys[a.keyCode]=!0,a.stopPropagation()},_keyUp:function(a){"use strict";this.keys[a.keyCode]=!1,a.stopPropagation()},isKeyDown:function(a,b){"use strict";var c=this.keys[a];return b&&(this.keys[a]=!1),c},left:function(a){"use strict";return this.isKeyDown(gtp.Keys.LEFT_ARROW,a)},right:function(a){"use strict";return this.isKeyDown(gtp.Keys.RIGHT_ARROW,a)},up:function(a){"use strict";return this.isKeyDown(gtp.Keys.UP_ARROW,a)}};var gtp=gtp||{};gtp.Keys=Object.freeze({ENTER:13,SHIFT:16,SPACE:32,LEFT_ARROW:37,UP_ARROW:38,RIGHT_ARROW:39,DOWN_ARROW:40,A:65,B:66,C:67,D:68,E:69,F:70,G:71,H:72,I:73,J:74,K:75,L:76,M:77,N:78,O:79,P:80,Q:81,R:82,S:83,T:84,U:85,V:86,W:87,X:88,Y:89,Z:90});var gtp=gtp||{};gtp.Game=function(a){"use strict";gtp.Utils.initConsole(),a=a||{},this._scale=a.scale||1,this.canvas=gtp.ImageUtils.createCanvas(a.width,a.height,a.parent),this.inputManager=new gtp.InputManager,this.inputManager.install(),this._gameTime=0,this._targetFps=a.targetFps||30,this._interval=1e3/this._targetFps,this.lastTime=null,this.audio=new gtp.AudioSystem,this.audio.init();var b=a.assetRoot||null;this.assets=new gtp.AssetLoader(this._scale,this.audio,b),this.clearScreenColor="rgb(0,0,0)",this.fpsColor="rgb(255,255,255)",this.statusMessageRGB="255,255,255",this._statusMessageColor=null,this.showFps=!0,this.frames=0,this._fpsMsg=this._targetFps+" fps",this._statusMessage=null,this._statusMessageAlpha=0,this.timer=new gtp.Timer},gtp.Game.prototype={start:function(){"use strict";var a=this,b=function(){a._gameTime+=a._interval,a._tick.apply(a)};setInterval(b,this._interval)},_tick:function(){"use strict";if(this._statusMessage){var a=(new Date).getTime();if(a>this._statusMessageTime){this._statusMessageTime=a+100,this._statusMessageAlpha-=.1;var b=Math.min(1,this._statusMessageAlpha);this._statusMessageColor="rgba("+this.statusMessageRGB+","+b+")",this._statusMessageAlpha<=0&&(this._statusMessage=null)}}this.update(),this.render()},update:function(){"use strict";var a=this.inputManager;a.isKeyDown(gtp.Keys.SHIFT)&&a.isKeyDown(gtp.Keys.F,!0)&&game.toggleShowFps(),this.state.update(this._interval)},render:function(){"use strict";var a=this.canvas.getContext("2d");this.state.render(a),this.showFps&&this._renderFps(a),this._statusMessage&&this._statusMessageAlpha>0&&this._renderStatusMessage(a)},getGameTime:function(){"use strict";return this._gameTime},getHeight:function(){"use strict";return this.canvas.height},getWidth:function(){"use strict";return this.canvas.width},randomInt:function(a){"use strict";var b=0;return Math.floor(Math.random()*(a-b+1)+b)},setState:function(a){"use strict";this.state&&this.state.leaving(this),this.state=a,this.state.init()},_renderStatusMessage:function(a){"use strict";var b=10,c=this.canvas.height-30;a.font="Dragon Warrior 2",a.fillStyle=this._statusMessageColor,a.fillText(this._statusMessage,b,c)},_renderFps:function(a){"use strict";this.frames++;var b=(new Date).getTime();null===this.lastTime?this.lastTime=b:b-this.lastTime>=1e3&&(this._fpsMsg=this.frames+" fps",this.frames=0,this.lastTime=b);var c=10,d=15;a.font="10pt Arial",a.fillStyle=this.fpsColor,a.fillText(this._fpsMsg,c,d)},setStatusMessage:function(a){"use strict";this._statusMessage=a,this._statusMessageAlpha=2,this._statusMessageTime=(new Date).getTime()+100},toggleShowFps:function(){"use strict";this.showFps=!this.showFps,this.setStatusMessage("FPS display: "+(this.showFps?"on":"off"))},clearScreen:function(a){"use strict";var b=a||this.clearScreenColor,c=this.canvas.getContext("2d");c.fillStyle=b,c.fillRect(0,0,this.getWidth(),this.getHeight())}};var gtp=gtp||{};gtp.Sound=function(a,b,c){"use strict";this._id=a,this._buffer=b,this._loopsByDefault=!0,this._loopStart=c||0},gtp.Sound.prototype={get buffer(){"use strict";return this._buffer},get id(){"use strict";return this._id},get loopsByDefaultIfMusic(){"use strict";return this._loopsByDefault},set loopsByDefaultIfMusic(a){"use strict";this._loopsByDefault=a},get loopStart(){"use strict";return this._loopStart},set loopStart(a){"use strict";this._loopStart=a}};var gtp=gtp||{};gtp.State=function(a){"use strict";a instanceof gtp.Game?this.game=a:a&&a.game?this.game=a.game:this.game=window.game},gtp.State.prototype={init:function(){},leaving:function(a){},update:function(a){},render:function(a){}};var gtp=gtp||{};gtp.FadeOutInState=function(a,b,c,d){"use strict";gtp.State.apply(this,arguments),this._leavingState=a,this._enteringState=b,this._transitionLogic=c,this._fadingOut=!0,this._alpha=1,this._halfTime=d&&d>0?d/2:800,this._curTime=0},gtp.FadeOutInState.prototype=Object.create(gtp.State.prototype,{update:{value:function(a){"use strict";if(this._curTime+=a,this._curTime>=this._halfTime){if(this._curTime-=this._halfTime,!this._fadingOut)return void this._setState(this._enteringState);this._fadingOut=!1,this._transitionLogic&&this._transitionLogic()}var b;this._fadingOut?(this._alpha=1-this._curTime/this._halfTime,b=this._leavingState):(this._alpha=this._curTime/this._halfTime,b=this._enteringState)}},render:{value:function(a){"use strict";game.clearScreen();var b=a.globalAlpha;a.globalAlpha=this._alpha,this._fadingOut?this._leavingState.render(a):this._enteringState.render(a),a.globalAlpha=b}},_setState:{value:function(a){"use strict";game.setState(this._enteringState)}}}),gtp.FadeOutInState.prototype.constructor=gtp.FadeOutInState;var tiled=tiled||{};tiled.TiledTileset=function(a,b){"use strict";this.firstgid=a.firstgid,this.image=a.image,b&&(this.image=b(this.image)),this.imageWidth=a.imagewidth,this.imageHeight=a.imageheight,this.margin=a.margin,this.name=a.name,this.properties=a.properties,this.spacing=a.spacing,this.tileWidth=a.tilewidth,this.tileHeight=a.tileheight},tiled.TiledTileset.prototype={setScale:function(a){"use strict";this.imageWidth*=a,this.imageHeight*=a,this.tileWidth*=a,this.tileHeight*=a,this.margin*=a,this.spacing*=a}};var tiled=tiled||{};tiled.TiledMap=function(a,b){"use strict";this.rowCount=a.height,this.colCount=a.width,this.tileWidth=b.tileWidth,this.tileHeight=b.tileHeight,this.screenWidth=b.screenWidth,this.screenHeight=b.screenHeight,this.screenRows=Math.ceil(this.screenHeight/this.tileHeight),this.screenCols=Math.ceil(this.screenWidth/this.tileWidth);var c=b?b.imagePathModifier:null;this.layers=[],this.layersByName={},this.objectGroups=[];for(var d=0;d<a.layers.length;d++)this.addLayer(a.layers[d]);if(this.tilesets=[],a.tilesets&&a.tilesets.length)for(d=0;d<a.tilesets.length;d++)this.tilesets.push(new tiled.TiledTileset(a.tilesets[d],c));this.properties=a.properties,this.version=a.version,this.orientation=a.orientation},tiled.TiledMap.prototype={addLayer:function(a){"use strict";var b=new tiled.TiledLayer(this,a);this.layers.push(b),this.layersByName[b.name]=b,"objectgroup"===a.type&&(b.objectGroup=!0,this.objectGroups.push(b))},draw:function(a,b,c,d,e){"use strict";d=d||0,e=e||0;var f=this.colCount,g=this.rowCount,h=this.screenRows,i=this.screenCols,j=this.tileWidth,k=this.tileHeight,l=j,m=this.screenWidth,n=this.screenHeight,o=c-Math.floor(h/2);0>o&&(o+=f);var p=b-Math.floor(i/2);0>p&&(p+=g);var q=c*j+d+j/2,r=b*k+e+k/2,s=q-m/2,t=r-n/2,u=Math.floor(s/j);0>s%l&&u--;var v=u*j,w=Math.floor(t/k);0>t%l&&w--;var x=w*k,y=v-s,z=y,A=x-t,B=A;0>u&&(u+=f),0>w&&(w+=g);for(var C=w,D=this.getLayerCount(),E=0;n>B;){for(var F=0;D>F;F++){var G=u;z=y;var H=this.getLayerByIndex(F);if(H.visible){var I;for(H.opacity<1&&(I=a.globalAlpha,a.globalAlpha=I*H.opacity);m>z;){var J=H.getData(C%g,G%f);this.drawTile(a,z,B,J,H),E++,z+=j,G++}H.opacity<1&&(a.globalAlpha=I)}}B+=k,C++}},getLayer:function(a){"use strict";return this.layersByName[a]},getLayerByIndex:function(a){"use strict";return this.layers[a]},getLayerCount:function(){"use strict";return this.layers.length},_getImageForGid:function(a){"use strict";for(var b=this.tilesets.length,c=0;b>c;c++)if(this.tilesets[c].firstgid>a)return this.tilesets[c-1];return this.tilesets[b-1]},drawTile:function(a,b,c,d,e){"use strict";if(!(0>=d)){var f=this._getImageForGid(d);if(!f)return void console.log("null tileset for: "+d+" (layer "+e.name+")");if(d-=f.firstgid,!(0>d)){var g=game.assets.getTmxTilesetImage(f),h=this.tileWidth,i=h+f.spacing,j=this.tileHeight,k=j+f.spacing,l=Math.floor(g.width/i);f.spacing>0&&g.width%i===h&&l++;var m=Math.floor(d/l)*k,n=d%l*i;g.drawScaled2(a,n,m,h,j,b,c,h,j)}}},setScale:function(a){"use strict";this.tileWidth*=a,this.tileHeight*=a,this.screenRows=Math.ceil(this.screenHeight/this.tileHeight),this.screenCols=Math.ceil(this.screenWidth/this.tileWidth);for(var b=this.tilesets.length,c=0;b>c;c++)return this.tilesets[c].setScale(a)},getPixelWidth:function(){"use strict";return this.colCount*this.tileWidth},getPixelHeight:function(){"use strict";return this.rowCount*this.tileHeight},removeLayer:function(a){"use strict";for(var b=0;b<this.layers.length;b++){if(this.layers[b].name===a){this.layers.splice(b,1),delete this.layersByName[a];for(var c=0;c<this.objectGroups.length;c++)this.objectGroups[c].name===a&&delete this.objectGroups[c]}return!0}return!1}};var tiled=tiled||{};tiled.TiledObject=function(a){"use strict";gtp.Utils.mixin(a,this),this.properties=this.properties||{},this.gid=this.gid||-1,this.x*=game._scale,this.y*=game._scale,this.width*=game._scale,this.height*=game._scale},tiled.TiledObject.prototype={intersects:function(a,b,c,d){"use strict";var e=this.width,f=this.height,g=c,h=d;if(0>=g||0>=h||0>=e||0>=f)return!1;var i=this.x,j=this.y,k=a,l=b;return g+=k,h+=l,e+=i,f+=j,(k>g||g>i)&&(l>h||h>j)&&(i>e||e>k)&&(j>f||f>l)}};var tiled=tiled||{};tiled.TiledLayer=function(a,b){"use strict";this.map=a,this.name=b.name,this.width=b.width,this.height=b.height,this.data=b.data,this.opacity=b.opacity,this.visible=b.visible,this.type=b.type,this.x=b.x,this.y=b.y,this._setObjects(b.objects)},tiled.TiledLayer.prototype={getData:function(a,b){"use strict";if(!this.data)return-1;var c=a*this.map.colCount+b;return this.data[c]},setData:function(a,b,c){"use strict";if(!this.data)return!1;var d=a*this.map.colCount+b;this.data[d]=c},getObjectByName:function(a){"use strict";return this.objectsByName?this.objectsByName[a]:null},getObjectIntersecting:function(a,b,c,d){"use strict";if(this.objects)for(var e=0;e<this.objects.length;e++){var f=this.objects[e];if(f.intersects(a,b,c,d))return f}return null},isObjectGroup:function(){"use strict";return"objectgroup"===this.type},_setObjects:function(a){"use strict";if(a){this.objects=[],this.objectsByName={};for(var b=0;b<a.length;b++){var c=new tiled.TiledObject(a[b]);this.objects.push(c),this.objectsByName[a[b].name]=c}}}},dw.DwGame=function(){"use strict";gtp.Game.apply(this,arguments),this.map=null,this._drawMapCount=0},dw.DwGame.prototype=Object.create(gtp.Game.prototype,{start:{value:function(){"use strict";gtp.Game.prototype.start.apply(this,arguments),this._init()}},_init:{value:function(){"use strict";this._createPartyAndHero(),this.npcs=[],this._bumpSoundDelay=0,this._mapLogics={},this.setCameraOffset(0,0)}},_createPartyAndHero:{value:function(){"use strict";this.hero=new dw.Hero({name:"Erdrick"}),this.party=new dw.Party(this),this.party.addMember(this.hero)}},update:{value:function(){"use strict";gtp.Game.prototype.update.call(this)}},cycleArmor:{value:function(){"use strict";if(game.hero&&game.hero.armor){var a,b=game.hero.armor.name,c=game.assets.get("armorArray");for(a=0;a<c.length&&b!==c[a].name;a++);a=(a+1)%c.length,game.hero.armor=c[a],this.setStatusMessage("Armor changed to: "+game.hero.armor.name)}}},cycleShield:{value:function(){"use strict";if(game.hero&&game.hero.shield){var a,b=game.hero.shield.name,c=game.assets.get("shieldArray");for(a=0;a<c.length&&b!==c[a].name;a++);a=(a+1)%c.length,game.hero.shield=c[a],this.setStatusMessage("dw.Shield changed to: "+game.hero.shield.name)}}},cycleWeapon:{value:function(){"use strict";if(game.hero&&game.hero.weapon){var a,b=game.hero.weapon.name,c=game.assets.get("weaponsArray");for(a=0;a<c.length&&b!==c[a].name;a++);a=(a+1)%c.length,game.hero.weapon=c[a],this.setStatusMessage("Weapon changed to: "+game.hero.weapon.name)}}},drawMap:{value:function(a){"use strict";var b=game.hero,c=b.mapCol,d=b.mapRow,e=b.xOffs+this._cameraDx,f=b.yOffs+this._cameraDy;this._drawMapCount++,this.map.draw(a,d,c,e,f)}},getEnemy:{value:function(a){"use strict";return this.assets.get("enemies")[a]}},getMapLogic:{value:function(){"use strict";var a=this.map.properties.logicFile;a=a.charAt(0).toUpperCase()+a.substring(1),console.log(a);var b=this._mapLogics[a];return b||(b=this._mapLogics[a]=new window[a]),b}},getMapXOffs:{value:function(){"use strict";var a=this.hero,b=a.mapCol,c=a.xOffs,d=this.getTileSize(),e=b*d+d/2+c-this.getWidth()/2;return e}},getMapYOffs:{value:function(){"use strict";var a=this.hero,b=a.mapRow,c=a.yOffs,d=this.getTileSize(),e=b*d+d/2+c-this.getHeight()/2;return e}},getParty:{value:function(){"use strict";return this.party}},loadMap:{value:function(a,b,c,d){"use strict";this.newRow=b,this.newCol=c,this.audio.playSound("stairs");var e=this,f=function(){e.hero.setMapLocation(-1,-1),e.setMap(a+".json"),e.hero.setMapLocation(b,c),e.hero.direction="undefined"==typeof d?dw.Direction.SOUTH:d,e.inputManager.clearKeyStates()};this.setState(new dw.MapChangeState(this.state,this.state,f))}},getMapImpl:{value:function(a){"use strict";var b=null;return b=this.assets.get(a+".json")}},_resetMap:{value:function(a){"use strict";for(var b=0;b<a.npcs.length;b++)a.npcs[b].reset()}},setMap:{value:function(a){"use strict";console.log("Setting map to: "+a),this.map=this.maps[a],this._resetMap(this.map);var b=dw.Sounds[this.map.properties.music];b!==this.audio.getCurrentMusic()&&this.audio.fadeOutMusic(b)}},initLoadedMap:{value:function(a){"use strict";var b=this.assets.get(a),c=function(a){return a.replace("../","res/")};this.maps||(this.maps={});var d=new tiled.TiledMap(b,{imagePathModifier:c,tileWidth:16,tileHeight:16,screenWidth:game.getWidth(),screenHeight:game.getHeight()});return this._adjustGameMap(d),d.setScale(this._scale),this.maps[a]=d,d}},_adjustGameMap:{value:function(a){"use strict";var b,c;for(b=0;b<a.getLayerCount();b++){var d=a.getLayerByIndex(b);"tileLayer"!==d.name&&(d.visible=!1)}var e=[],f={},g=a.getLayer("npcLayer");if(g&&g.isObjectGroup()){var h=g;for(b=0;b<h.objects.length;b++){var i=h.objects[b];"npc"===i.type?(c=this._parseNpc(i),c.setNpcIndex(e.length+1),e.push(c)):"talkAcross"===i.type?f[this._parseTalkAcrossKey(i)]=!0:console.error("Unhandled object type in tiled map: "+i.type)}a.removeLayer("npcs")}for(a.npcs=e,b=0;b<a.npcs.length;b++)c=a.npcs[b],a.getLayer("collisionLayer").setData(c.mapRow,c.mapCol,1);a.talkAcrosses=f}},_parseNpc:{value:function(a){"use strict";var b,c=a.name;a.properties.type&&(b=dw.NpcType[a.properties.type.toUpperCase()]),null==b&&(b=dw.NpcType.MERCHANT_GREEN);var d=this.getTileSize(),e=a.y/d,f=a.x/d,g=dw.Direction.SOUTH,h=a.properties.dir;h&&(g=dw.Direction[h.toUpperCase()],"undefined"==typeof g&&(g=dw.Direction.SOUTH));var i=!0,j=a.properties.wanders;j&&(i="true"===j);var k=this._parseRange(a.properties.range),l=new dw.Npc({name:c,type:b,direction:g,range:k,wanders:i,mapRow:e,mapCol:f});return l}},_parseRange:{value:function(a){"use strict";var b=null;return a&&(b=a.split(/,\s*/),b=b.map(function(a){return parseInt(a);
})),b}},_parseTalkAcrossKey:{value:function(a){"use strict";var b=this.getTileSize(),c=a.y/b,d=a.x/b;return this._getTalkAcrossKey(c,d)}},_getTalkAcrossKey:{value:function(a,b){"use strict";return a+","+b}},_loadGame:{value:function(){"use strict";var a=game.hero;a.hp=a.maxHp=15,a.mp=a.maxMp=15,a._strength=4,a.agility=4,a.weapon=game.assets.get("weapons").club,a.armor=game.assets.get("armor").clothes,a.shield=game.assets.get("shields").smallShield}},setCameraOffset:{value:function(a,b){"use strict";this._cameraDx=a,this._cameraDy=b}},startNewGame:{value:function(){"use strict";this._loadGame();var a=function(){game.setMap("brecconary.json"),game.hero.setMapLocation(7,6)};game.setState(new gtp.FadeOutInState(this.state,new dw.RoamingState,a))}},toggleMuted:{value:function(){"use strict";var a=this.audio.toggleMuted();this.setStatusMessage(a?"Audio muted":"Audio enabled")}},toggleShowCollisionLayer:{value:function(){"use strict";var a=this.getCollisionLayer();a.visible=!a.visible,this.setStatusMessage(a.visible?"Collision layer showing":"Collision layer hidden")}},toggleShowTerritoryLayer:{value:function(){"use strict";var a=this.map.getLayer("enemyTerritoryLayer");a.visible=!a.visible,this.setStatusMessage(a.visible?"Territory layer showing":"Territory layer hidden")}},getTileSize:{value:function(){"use strict";return 16*this._scale}},getCollisionLayer:{value:function(){"use strict";return game.map.getLayer("collisionLayer")}},getEnemyTerritoryLayer:{value:function(){"use strict";return game.map.getLayer("enemyTerritoryLayer")}},bump:{value:function(){"use strict";this._gameTime>this._bumpSoundDelay&&(this.audio.playSound("bump"),this._bumpSoundDelay=this._gameTime+300)}},setNpcsPaused:{value:function(a){"use strict";this.npcsPaused=a}},stringHeight:{value:function(){"use strict";return this.assets.get("font").cellH}},stringWidth:{value:function(a){"use strict";return a?a.length*this.assets.get("font").cellW:0}},drawString:{value:function(a,b,c){"use strict";a.charAt||(a=a.toString()),this.assets.get("font").drawString(a,b,c)}},drawArrow:{value:function(a,b){"use strict";this.drawString("",a,b)}},drawDownArrow:{value:function(a,b){"use strict";this.drawString("\\",a,b)}},startRandomEncounter:{value:function(){"use strict";var a=game.getEnemyTerritoryLayer();if(a){var b=a.getData(game.hero.mapRow,game.hero.mapCol);if(b>0&&(b-=game.map._getImageForGid(b).firstgid,b>=0)){var c=game.assets.get("enemyTerritories"),d=c[b],e=d[gtp.Utils.randomInt(0,d.length)];this.setState(new dw.BattleTransitionState(this.state,new dw.BattleState(e)))}}}},getNpcHeroIsFacing:{value:function(){"use strict";var a=this.hero.mapRow,b=this.hero.mapCol;do switch(this.hero.direction){case dw.Direction.NORTH:a--;break;case dw.Direction.SOUTH:a++;break;case dw.Direction.EAST:b++;break;case dw.Direction.WEST:b--}while(this.getShouldTalkAcross(a,b));for(var c=0;c<this.map.npcs.length;c++){var d=this.map.npcs[c];if(a===d.mapRow&&b===d.mapCol)return d}return null}},getShouldTalkAcross:{value:function(a,b){"use strict";return this.map.talkAcrosses[this._getTalkAcrossKey(a,b)]}},anyKeyDown:{value:function(a){"use strict";"undefined"==typeof a&&(a=!0);var b=this.inputManager;return b.isKeyDown(gtp.Keys.Z,a)||b.isKeyDown(gtp.Keys.X,a)||b.enter(a)}},actionKeyPressed:{value:function(){"use strict";return this.inputManager.isKeyDown(gtp.Keys.Z,!0)}},cancelKeyPressed:{value:function(){"use strict";return this.inputManager.isKeyDown(gtp.Keys.X,!0)}},getWeapon:{value:function(a){"use strict";return this.assets.get("weapons")[a]}},getArmor:{value:function(a){"use strict";return this.assets.get("armors")[a]}},getShield:{value:function(a){"use strict";return this.assets.get("shields")[a]}}}),dw.DwGame.prototype.constructor=dw.DwGame,dw._BaseState=function(a){"use strict";gtp.State.apply(this,arguments)},dw._BaseState.prototype=Object.create(gtp.State.prototype,{createScreenshot:{value:function(){"use strict";var a=gtp.ImageUtils.createCanvas(game.getWidth(),game.getHeight()),b=a.getContext("2d");return this.render(b),a}},handleDefaultKeys:{value:function(){"use strict";var a=this.game.inputManager;a.isKeyDown(gtp.Keys.SHIFT)&&(a.isKeyDown(gtp.Keys.P,!0)?(game.canvas.style.width||(game.canvas.style.width=game.canvas.width+"px"),game.canvas.style.height||(game.canvas.style.height=game.canvas.height+"px"),game.canvas.style.width=parseInt(game.canvas.style.width.substring(0,game.canvas.style.width.length-2),10)+1+"px",game.canvas.style.height=parseInt(game.canvas.style.height.substring(0,game.canvas.style.height.length-2),10)+1+"px"):a.isKeyDown(gtp.Keys.L,!0)?(game.canvas.style.width||(game.canvas.style.width=game.canvas.width+"px"),game.canvas.style.height||(game.canvas.style.height=game.canvas.height+"px"),console.log("... "+game.canvas.width+", "+game.canvas.style.width+", "+game.canvas.style.width.substring(0,game.canvas.style.width-2)),game.canvas.style.width=parseInt(game.canvas.style.width.substring(0,game.canvas.style.width.length-2),10)-1+"px",game.canvas.style.height=parseInt(game.canvas.style.height.substring(0,game.canvas.style.height.length-2),10)-1+"px"):a.isKeyDown(gtp.Keys.M,!0)?game.toggleMuted():a.isKeyDown(gtp.Keys.W,!0)?game.cycleWeapon():a.isKeyDown(gtp.Keys.A,!0)?game.cycleArmor():a.isKeyDown(gtp.Keys.S,!0)&&game.cycleShield())}}}),dw._BaseState.prototype.constructor=dw._BaseState,dw.Armor=function(){"use strict";var a=function(a,b){this.name=a,this.baseCost=b.baseCost||0,this.defense=b.defense||1,this.displayName=b.displayName||this.name};return a.prototype={toString:function(){return"[dw.Armor: name="+this.name+", baseCost="+this.baseCost+", defense="+this.defense+"]"}},a.prototype.constructor=dw.Armor,a}(),dw.BattleEntity=function(a){"use strict";a=a||{},this.hp=a.hp||0,this.maxHp=a.hp||0,this.mp=a.mp||0,this.maxMp=a.mp||0},dw.BattleEntity.prototype={isDead:function(){"use strict";return this.hp<=0},takeDamage:function(a){"use strict";return this.hp=Math.max(0,this.hp-a),this.isDead()}},dw.EnemyAI=Object.freeze({attackOnly:function(a,b){"use strict";return{type:"physical",damage:b.computePhysicalAttackDamage(a)}},get:function(a){"use strict";return dw.EnemyAI[a]?dw.EnemyAI[a]:(console.error("Unknown dw.EnemyAI: "+a+". Falling back on attackOnly"),this.attackOnly)}}),dw.Enemy=function(a){"use strict";gtp.Utils.mixin(a,this),dw.BattleEntity.call(this,a),gtp.Utils.mixin(dw.RoamingEntity.prototype,this),this.ai=dw.EnemyAI.get(this.ai)},dw.Enemy.prototype=Object.create(dw.BattleEntity.prototype,{computePhysicalAttackDamage:{value:function(a){"use strict";if(a.getDefense()>=this.str)return gtp.Utils.randomInt(0,Math.floor((this.str+4)/6)+1);var b=this.str-Math.floor(a.getDefense()/2),c=Math.floor(b/4),d=Math.floor(b/2);return gtp.Utils.randomInt(c,d+1)}},getImage:{value:function(a){"use strict";return game.assets.get(a?this.damagedImage:this.image)}},prepare:{value:function(){"use strict";return this.hp.length&&(this.hp=gtp.Utils.randomInt(this.hp[0],this.hp[1]+1)),this}}}),dw.Enemy.prototype.constructor=dw.Enemy,dw.Weapon=function(a,b){"use strict";this.name=a,this.baseCost=b.baseCost||0,this.power=b.power||1,this.displayName=b.displayName||this.name},dw.Weapon.prototype={toString:function(){"use strict";return"[dw.Weapon: name="+this.name+", baseCost="+this.baseCost+", power="+this.power+"]"}},dw.Weapon.prototype.constructor=dw.Weapon,dw.RoamingEntity=function(){"use strict";this.direction=this.direction||dw.Direction.SOUTH,this.mapCol=this.mapCol||0,this.mapRow=this.mapRow||0,this.xOffs=this.xOffs||0,this.yOffs=this.yOffs||0,this._stepTick=0,this._moveInc=game._scale*(30===game._targetFps?2:1)},dw.RoamingEntity.prototype={getMoveIncrement:function(){"use strict";return this._moveInc},isMoving:function(){"use strict";return 0!==this.xOffs||0!==this.yOffs},handleIsMovingInUpdate:function(){"use strict";this.isMoving()&&(this.xOffs<0?this.xOffs+=this.getMoveIncrement():this.xOffs>0?this.xOffs-=this.getMoveIncrement():this.yOffs<0?this.yOffs+=this.getMoveIncrement():this.yOffs>0&&(this.yOffs-=this.getMoveIncrement()),this.isMoving()||this.handlePostMove())},handlePostMove:function(){},_isOutOfRange:function(a,b){"use strict";return this.range?b<this.range[0]||b>this.range[2]||a<this.range[1]||a>this.range[3]:!1},setMapLocation:function(a,b){"use strict";if(null!=this.mapRow&&null!=this.mapCol){var c=game.getCollisionLayer();c.setData(this.mapRow,this.mapCol,0),a>-1&&b>-1&&c.setData(a,b,1)}this.mapRow=a,this.mapCol=b,this.xOffs=this.yOffs=0},_tryToMove:function(a,b){"use strict";if(this._isOutOfRange(a,b))return!1;var c=game.getCollisionLayer().getData(a,b),d=0===c;return d?this.setMapLocation(a,b):361===c&&this.constructor===dw.Hero&&game.bump(),d},tryToMoveLeft:function(){"use strict";var a=!1,b=this.mapCol-1;return 0>b&&(b+=game.map.colCount),this._tryToMove(this.mapRow,b)&&(this.xOffs=game.getTileSize(),a=!0),this.direction=dw.Direction.WEST,a},tryToMoveRight:function(){"use strict";var a=!1,b=Math.floor((this.mapCol+1)%game.map.colCount);return this._tryToMove(this.mapRow,b)&&(this.xOffs=-game.getTileSize(),a=!0),this.direction=dw.Direction.EAST,a},tryToMoveUp:function(){"use strict";var a=!1,b=this.mapRow-1;return 0>b&&(b+=game.map.rowCount),this._tryToMove(b,this.mapCol)&&(this.yOffs+=game.getTileSize(),a=!0),this.direction=dw.Direction.NORTH,a},tryToMoveDown:function(){"use strict";var a=!1,b=Math.floor((this.mapRow+1)%game.map.rowCount);return this._tryToMove(b,this.mapCol)&&(this.yOffs-=game.getTileSize(),a=!0),this.direction=dw.Direction.SOUTH,a}},dw.Bubble=function(a,b,c,d,e){"use strict";this.title=a;var f=1;this.x=b*f,this.y=c*f,this.w=d*f,this.h=e*f,this._fontWidth=game.assets.get("font").cellW},dw.Bubble.MARGIN=10,dw.Bubble.prototype={_breakApart:function(a,b){"use strict";var c={lines:[],delays:[]};a=this._removeSpecialEscapes(a,c.delays);for(var d=a.split("\n"),e=0;e<d.length;e++)this._breakApartLine(d[e],b,c);return c},_removeSpecialEscapes:function(a,b){"use strict";for(var c,d,e=0;(d=a.indexOf("\\d",e))>-1;){if(d+2<a.length&&"{"===a.charAt(d+2)){var f=a.indexOf("}",d+3);f>-1?(c=parseInt(a.substring(d+3,f)),console.log("Adding a delay of "+c+" ms"),b.push({offs:d,millis:c}),a=a.substring(0,d)+a.substring(f+1)):console.warn("Suspicious, apparent unclosed delay at offset "+d)}else c=500,console.log("Adding the default delay of "+c+" ms"),b.push({offs:d,millis:c}),a=a.substring(0,d)+a.substring(d+2);e=d}return a},_breakApartLine:function(a,b,c){"use strict";for(var d=Math.floor(b/this._fontWidth);a.length>d;){for(var e=d-1,f=a.charAt(e);" "!==f;)f=a.charAt(--e);c.lines.push(a.substring(0,e)),a=a.substring(e).trim()}c.lines.push(a)},paint:function(a){"use strict";var b=game._scale,c=game.stringHeight();a.fillStyle="rgb(0,0,0)",a.fillRect(this.x,this.y,this.w,this.h),a.strokeStyle="rgb(255,255,255)",a.lineWidth=2;var d=2*b;if(a.strokeRect(this.x+d,this.y+d,this.w-2*d,this.h-2*d),this.title){a.fillStyle="rgb(0,0,0)";var e=game.stringWidth(this.title);e+=4*b;var f=this.x+Math.floor((this.w-e)/2);a.fillRect(f,this.y,e,c),a.fillStyle="rgb(255,255,255)",game.drawString(this.title,f+2*b,this.y)}this.paintContent(a,this.y+this.getYMargin())},getXMargin:function(){"use strict";return 8*game._scale},getYMargin:function(){"use strict";return this.title?game.getTileSize():8*game._scale},update:function(a){},paintContent:function(a,b){}},dw.BattleCommandBubble=function(){"use strict";var a=game.getTileSize();dw.Bubble.call(this,"COMMAND",8*a,a,8*a,3*a),this.selection=0},dw.BattleCommandBubble.prototype=Object.create(dw.Bubble.prototype,{handleCommandChosen:{value:function(a){"use strict";switch(this.selection){case 0:a.fight();break;case 1:a.run();break;case 2:a.spell();break;case 3:a.item()}}},handleInput:{value:function(){"use strict";var a=game.inputManager;if(a.up(!0))this.selection=this.selection-1,this.selection<0&&(this.selection=3);else if(a.down(!0))this.selection=Math.floor((this.selection+1)%4);else if(this.selection>1&&a.left(!0))this.selection-=2;else if(this.selection<2&&a.right(!0))this.selection+=2;else{if(game.cancelKeyPressed())return this.reset(),!1;if(game.actionKeyPressed())return game.audio.playSound("menu"),!0}return!1}},paintContent:{value:function(a,b){"use strict";var c=game._scale,d=this.x+20*c,e=b,f=game.stringHeight()+6*c;game.drawString("FIGHT",d,e),e+=f,game.drawString("RUN",d,e),e+=f,d+=64*c,e-=2*f,game.drawString("SPELL",d,e),e+=f,game.drawString("ITEM",d,e),e+=f,this.selection<2&&(d-=64*c),d-=game.stringWidth(">")+2*c,e=b+f*(this.selection%2),game.drawArrow(d,e)}},reset:{value:function(){"use strict";this.selection=0}}}),dw.BattleCommandBubble.prototype.constructor=dw.BattleCommandBubble,dw.CommandBubble=function(){"use strict";var a=game._scale,b=game.getTileSize(),c=140*a,d=90*a,e=game.getWidth()-b-c,f=b;dw.Bubble.call(this,"COMMAND",e,f,c,d),this.selection=0},dw.CommandBubble.prototype=Object.create(dw.Bubble.prototype,{handleCommandChosen:{value:function(a){"use strict";switch(this.selection){case-1:a.startRoaming();break;case 0:a.talkToNpc();break;case 1:a.showStatus();break;case 2:break;case 3:break;case 4:break;case 5:a.showInventory();break;case 6:break;case 7:}}},handleInput:{value:function(){"use strict";var a=game.inputManager;if(a.up(!0))this.selection=this.selection-1,this.selection<0&&(this.selection=7);else if(a.down(!0))this.selection=Math.floor((this.selection+1)%8);else if(this.selection>3&&a.left(!0))this.selection-=4;else if(this.selection<4&&a.right(!0))this.selection+=4;else{if(game.cancelKeyPressed())return this.selection=-1,!0;if(game.actionKeyPressed())return game.audio.playSound("menu"),!0}return!1}},paintContent:{value:function(a,b){"use strict";var c=game._scale,d=this.x+20*c,e=b,f=game.stringHeight()+7*c;game.drawString("TALK",d,e),e+=f,game.drawString("STATUS",d,e),e+=f,game.drawString("STAIRS",d,e),e+=f,game.drawString("SEARCH",d,e),e+=f,d+=70*c,e-=4*f,game.drawString("SPELL",d,e),e+=f,game.drawString("ITEM",d,e),e+=f,game.drawString("DOOR",d,e),e+=f,game.drawString("TAKE",d,e),e+=f,this.selection<4&&(d-=70*c),d-=game.stringWidth(">")+2*c,e=b+f*(this.selection%4),game.drawArrow(d,e)}},reset:{value:function(){"use strict";this.selection=0}}}),dw.CommandBubble.prototype.constructor=dw.CommandBubble,dw.ItemBubble=function(){"use strict";var a=game._scale,b=game.getTileSize(),c=7*b,d=100*a,e=9*b,f=3*b;dw.Bubble.call(this,null,e,f,c,d),this.selection=0},dw.ItemBubble.prototype=Object.create(dw.Bubble.prototype,{_calculateX2Offs:{value:function(a){"use strict";return game.stringWidth(""+a)}},handleInput:{value:function(){"use strict"}},paintContent:{value:function(a,b){"use strict";var c=game._scale,d=this.x+dw.Bubble.MARGIN,e=b,f=game.stringHeight()+7*c,g=game.party.getInventory();g.forEach(function(a){game.drawString(a.displayName,d,e),e+=f})}}}),dw.ItemBubble.prototype.constructor=dw.ItemBubble,dw.StatBubble=function(){"use strict";var a=game._scale,b=game.getTileSize(),c=60*a,d=100*a,e=b,f=b,g=game.hero.name;g.length>4&&(g=g.substring(0,4)),dw.Bubble.call(this,g,e,f,c,d),this.selection=0},dw.StatBubble.prototype=Object.create(dw.Bubble.prototype,{_calculateX2Offs:{value:function(a){"use strict";return game.stringWidth(""+a)}},handleInput:{value:function(){"use strict"}},paintContent:{value:function(a,b){"use strict";var c=game._scale,d=this.x+dw.Bubble.MARGIN,e=this.x+this.w-dw.Bubble.MARGIN,f=b,g=game.stringHeight()+7*c,h=game.party,i=game.hero;game.drawString("LV",d,f);var j=this._calculateX2Offs(i.level);game.drawString(""+i.level,e-j,f),f+=g,game.drawString("HP",d,f),j=this._calculateX2Offs(i.hp),game.drawString(""+i.hp,e-j,f),f+=g,game.drawString("MP",d,f),j=this._calculateX2Offs(i.mp),game.drawString(""+i.mp,e-j,f),f+=g,game.drawString("G",d,f),j=this._calculateX2Offs(h.gold),game.drawString(""+h.gold,e-j,f),f+=g,game.drawString("E",d,f),j=this._calculateX2Offs(i.exp),game.drawString(""+i.exp,e-j,f),f+=g}}}),dw.StatBubble.prototype.constructor=dw.StatBubble,dw.StatusBubble=function(){"use strict";var a=game._scale,b=game.getTileSize(),c=172*a,d=game.getWidth()-b-c,e=3*b,f=game.getHeight()-e-b;dw.Bubble.call(this,null,d,e,c,f),this.selection=0},dw.StatusBubble.prototype=Object.create(dw.Bubble.prototype,{_calculateX2Offs:{value:function(a){"use strict";return a.length||(a=""+a),game.stringWidth(a)}},handleInput:{value:function(){"use strict"}},paintContent:{value:function(a,b){"use strict";var c=game._scale,d=this.x+dw.Bubble.MARGIN,e=this.x+this.w-dw.Bubble.MARGIN,f=b,g=game.stringHeight()+7*c,h=game.hero;game.drawString("NAME:",d,f);var i=this._calculateX2Offs(h.name);game.drawString(h.name,e-i,f),f+=g,game.drawString("STRENGTH:",d,f),i=this._calculateX2Offs(h._strength),game.drawString(h._strength,e-i,f),f+=g,game.drawString("AGILITY:",d,f),i=this._calculateX2Offs(h.agility),game.drawString(h.agility,e-i,f),f+=g;var j=h.getStrength();game.drawString("ATTACK POWER:",d,f),i=this._calculateX2Offs(j),game.drawString(j,e-i,f),f+=g;var k=h.getDefense();game.drawString("DEFENSE POWER:",d,f),i=this._calculateX2Offs(k),game.drawString(k,e-i,f),f+=g;var l=h.weapon?h.weapon.displayName:"";game.drawString("WEAPON:",d,f),i=this._calculateX2Offs(l),game.drawString(l,e-i,f),f+=g;var m=h.armor?h.armor.displayName:"";game.drawString("ARMOR:",d,f),i=this._calculateX2Offs(m),game.drawString(m,e-i,f),f+=g;var n=h.shield?h.shield.displayName:"";game.drawString("SHIELD:",d,f),i=this._calculateX2Offs(n),game.drawString(n,e-i,f),f+=g}}}),dw.StatusBubble.prototype.constructor=dw.StatusBubble,dw.TextBubble=function(a){"use strict";var b=a.getTileSize(),c=b,d=a.getWidth()-2*c,e=5*a.getTileSize(),f=a.getHeight()-b-e;dw.Bubble.call(this,null,c,f,d,e),this._doneCallbacks=[]},dw.TextBubble.CHAR_RENDER_MILLIS=0,dw.TextBubble.MAX_LINE_COUNT=6,dw.TextBubble.prototype=Object.create(dw.Bubble.prototype,{addToConversation:{value:function(a,b){"use strict";this._conversation.addSegment(a),b&&this._textDone?this._updateConversation():console.log("oh no - "+b+", "+this._textDone)}},_append:{value:function(a){"use strict";var b=a.currentText();this._text=this._text+"\n"+b,this._curLine=this._lines.length;var c=this.w-2*dw.Bubble.MARGIN,d=this._breakApart(b,c);this._lines=this._lines.concat(d.lines),this._delays=d.delays,this._curOffs=-1,this._curCharMillis=0,this._textDone=!1,console.log(">>> textDone set to false"),a.choices?this._questionBubble=new dw.QuestionBubble(game,a.choices):a.shopping&&(this._shoppingBubble=new dw.ShoppingBubble(game,a.shopping))}},handleInput:{value:function(){"use strict";var a,b;if(this._textDone){if(this._shoppingBubble){if(a=this._shoppingBubble.handleInput()){var c=this._shoppingBubble.getSelectedItem();return delete this._shoppingBubble,this._conversation.setItem(c),b=c.baseCost>game.party.gold?dw.Conversation.NOT_ENOUGH_SEGMENT:dw.Conversation.CONFIRM_SEGMENT,!this._updateConversation(b)}return!1}if(this._questionBubble)return a=this._questionBubble.handleInput(),a?(b=this._questionBubble.getSelectedChoiceNextDialogue(),delete this._questionBubble,!this._updateConversation(b)):!1}if(game.anyKeyDown()){if(this._textDone)return!this._updateConversation();this._textDone=!0,this._lines.length>dw.TextBubble.MAX_LINE_COUNT&&this._lines.splice(0,this._lines.length-dw.TextBubble.MAX_LINE_COUNT),this._curLine=this._lines.length-1}return!1}},_handleSegmentAudio:{value:function(a){"use strict";a.sound&&game.audio.playSound(a.sound),a.music&&game.audio.playMusic(a.music),a.afterSound&&(this._afterSound=a.afterSound)}},nudgeConversation:{value:function(){"use strict";this._updateConversation()}},isDone:{value:function(){"use strict";return!(!this._textDone||this._questionBubble||this._shoppingBubble||this._conversation&&this._conversation.hasNext())}},currentTextDone:{value:function(){"use strict";return this._textDone}},isOvernight:{value:function(){"use strict";return this._overnight}},clearOvernight:{value:function(a){"use strict";delete this._overnight}},onDone:{value:function(a){"use strict";this.isDone()?a():this._doneCallbacks.push(a)}},update:{value:function(a){"use strict";if(this._delay){if(!this._delay.update(a))return;delete this._delay}if(this._textDone)this._shoppingBubble?this._shoppingBubble.update(a):this._questionBubble&&this._questionBubble.update(a);else if(this._curCharMillis+=a,this._curCharMillis>dw.TextBubble.CHAR_RENDER_MILLIS){if(this._curCharMillis-=dw.TextBubble.CHAR_RENDER_MILLIS,-1===this._curOffs&&this._curLine===dw.TextBubble.MAX_LINE_COUNT&&(this._lines.shift(),this._curLine--),this._delays&&this._delays.length>0){var b=this._delays[0];if(b.offs===this._curOffs+1)return this._delays.shift(),void(this._delay=new gtp.Delay({millis:b.millis}))}this._curOffs++,this._curOffs===this._lines[this._curLine].length&&(this._curLine===this._lines.length-1?(console.log("Setting textDone to true"),this._textDone=!0,this._afterSound&&(game.audio.playSound(this._afterSound),delete this._afterSound)):(console.log("Going to next line"),this._curLine++),this._curOffs=-1)}this._doneCallbacks.length>0&&this.isDone()&&(this._doneCallbacks.forEach(function(a){a()}),this._doneCallbacks=[])}},paintContent:{value:function(a,b){"use strict";var c=this.x+dw.Bubble.MARGIN;if(a.fillStyle="rgb(255,255,255)",this._lines){for(var d=0;d<=this._curLine;d++){var e=this._lines[d];if(!this._textDone&&d===this._curLine){var f=Math.max(0,this._curOffs);e=e.substring(0,f)}game.drawString(e,c,b),b+=10*game._scale}this._textDone&&this._conversation.hasNext()&&game.drawDownArrow(this.x+this.w-30,this.y+this.h-30)}this._textDone&&(this._shoppingBubble?this._shoppingBubble.paint(a):this._questionBubble&&this._questionBubble.paint(a))}},_setText:{value:function(a){"use strict";if(this._text=a.currentText(),this._text){var b=this.w-2*dw.Bubble.MARGIN,c=this._breakApart(this._text,b);this._lines=c.lines,this._delays=c.delays,this._curLine=0,this._curOffs=-1,this._curCharMillis=0,this._textDone=!1,console.log(">>> textDone set to false")}a.choices?this._questionBubble=new dw.QuestionBubble(game,a.choices):a.shopping&&(this._shoppingBubble=new dw.ShoppingBubble(game,a.shopping.choices))}},setConversation:{value:function(a){"use strict";delete this._shoppingBubble,delete this._questionBubble,this._conversation=a;var b=this._conversation.start();this._setText(b),this._handleSegmentAudio(b)}},_updateConversation:{value:function(a){"use strict";if(a||this._conversation.hasNext()){this._conversation.current().overnight&&this._textDone&&(this._overnight=!0);var b;return a?(this._conversation.setDialogueState(a),b=this._conversation.current(!0)):b=this._conversation.next(!0),b.clear?this._setText(b):this._append(b),this._handleSegmentAudio(b),!0}return!1}}}),dw.TextBubble.prototype.constructor=dw.TextBubble,dw.QuestionBubble=function(a,b){"use strict";var c=a._scale,d=dw.Bubble.MARGIN*c,e=200*c,f=20*c,g=a.getWidth()-2*d,h=5*a.getTileSize();dw.Bubble.call(this,null,e,f,g,h),this._choices=b,this._curChoice=0},dw.QuestionBubble.prototype=Object.create(dw.Bubble.prototype,{handleInput:{value:function(){"use strict";if(game.cancelKeyPressed())this._curChoice=0;else if(game.actionKeyPressed())return this._done=!0,!0;return!1}},update:{value:function(a){"use strict";var b=game.inputManager;b.up(!0)?this._curChoice=Math.max(0,this._curChoice-1):b.down(!0)&&(this._curChoice=Math.min(this._curChoice+1,this._choices.length-1))}},paintContent:{value:function(a,b){"use strict";var c=this.x+dw.Bubble.MARGIN+10*game._scale;a.fillStyle="rgb(255,255,255)";for(var d=0;d<this._choices.length;d++)this._curChoice===d&&game.drawArrow(this.x+dw.Bubble.MARGIN,b),game.drawString(this._choices[d].text,c,b),b+=10*game._scale}},getSelectedChoiceNextDialogue:{value:function(){"use strict";var a=this._choices[this._curChoice];return a.next?a.next.length?a.next:a.next():null}},setChoices:{value:function(a){"use strict";this._choices=a}}}),dw.QuestionBubble.prototype.constructor=dw.QuestionBubble,dw.Direction=Object.freeze({NORTH:0,EAST:1,SOUTH:2,WEST:3,fromString:function(a){"use strict";if(!a||!a.length)return dw.Direction.SOUTH;switch(a.toUpperCase()){case"NORTH":return dw.Direction.NORTH;case"EAST":return dw.Direction.EAST;case"WEST":return dw.Direction.WEST;case"SOUTH":return dw.Direction.SOUTH;default:return dw.Direction.SOUTH}}}),dw.PartyMember=function(a){"use strict";dw.RoamingEntity.call(this,a),this.name=a.name,this.level=1,this.exp=12345,this._strength=4,this.agility=4,this.hp=a.hp||1234,this.maxHp=a.hp||0,this.mp=a.mp||0,this.maxMp=a.mp||0},dw.PartyMember.prototype=Object.create(dw.RoamingEntity.prototype,{computePhysicalAttackDamage:{value:function(a){"use strict";var b,c,d=this.getStrength();if(!a.cannotBeExcellentMoved&&this._getPerformExcellentMove())b=Math.floor(d/2),c=this._strength;else{var e=d-a.agility/2;b=Math.floor(e/4),c=Math.floor(e/2)}var f=gtp.Utils.randomInt(b,c+1);return 1>f&&(f=0===gtp.Utils.randomInt(0,2)?1:0),f}},getDefense:{value:function(){"use strict";var a=Math.floor(this.agility/2);return this.armor&&(a+=this.armor.defense),this.shield&&(a+=this.shield.defense),a}},_getPerformExcellentMove:{value:function(){"use strict";return 0===gtp.Utils.randomInt(0,32)}},getStrength:{value:function(){"use strict";return this._strength+(this.weapon?this.weapon.power:0)}},handleIntersectedObject:{value:function(a){"use strict"}},update:{value:function(a){"use strict";this._stepTick+=a,this._stepTick>=600?(this._stepTick-=600,dw.Hero.STEP_INC=0):this._stepTick>=300&&(dw.Hero.STEP_INC=1),this.handleIsMovingInUpdate()}},render:{value:function(a){"use strict";var b=game.getTileSize();this.spriteSheet||(this.spriteSheet=game.assets.get("hero"));var c=0,d=0;switch(this.direction){case dw.Direction.NORTH:d=4;break;case dw.Direction.SOUTH:break;case dw.Direction.EAST:d=6;break;case dw.Direction.WEST:d=2}d+=dw.Hero.STEP_INC;var e=(game.canvas.width-b)/2,f=(game.canvas.height-b)/2;this.spriteSheet.drawSprite(a,e,f,c,d)}},handlePostMove:{value:function(){"use strict";var a=game.map.getLayer("warpLayer"),b=game.getTileSize(),c=this.mapCol*b,d=this.mapRow*b,e=a.getObjectIntersecting(c,d,b,b);e?this.handleIntersectedObject(e):this._possiblyStartRandomEncounter()}},isDead:{value:function(){"use strict";return this.hp<=0}},_possiblyStartRandomEncounter:{value:function(){"use strict";0===game.randomInt(20)&&game.startRandomEncounter()}},replenishHealthAndMagic:{value:function(){"use strict";this.hp=this.maxHp,this.mp=this.maxMp}},takeDamage:{value:function(a){"use strict";return this.hp=Math.max(0,this.hp-a),this.hp=Math.max(1,this.hp),this.isDead()}}}),dw.PartyMember.prototype.constructor=dw.PartyMember,dw.Party=function(a){"use strict";this._members=[],this._inventory=[],this.gold=0,this.gold=768},dw.Party.INVENTORY_MAX_SIZE=20,dw.Party.prototype={addGold:function(a){"use strict";this.gold=Math.max(0,this.gold+a)},addInventoryItem:function(a){"use strict";return this.isInventoryFull()?!1:(this._inventory.push(a),!0)},addMember:function(a){"use strict";this._members.push(a)},getLeader:function(){"use strict";return this._members[0]},getInventory:function(){"use strict";return this._inventory},getMember:function(a){"use strict";for(var b=0;b<this._members.length;b++)if(this._members[b].name===a)return this._members[b];return null},getMembers:function(){"use strict";return this._members},isInventoryFull:function(){"use strict";return this._inventory.length>=dw.Party.INVENTORY_MAX_SIZE},replenishHealthAndMagic:function(){"use strict";this._members.forEach(function(a){a.replenishHealthAndMagic()})}},dw.Party.prototype.constructor=dw.Party,dw.Hero=function(a){"use strict";dw.PartyMember.call(this,a)},dw.Hero.STEP_INC=0,dw.Hero.prototype=Object.create(dw.PartyMember.prototype,{handleIntersectedObject:{value:function(a){"use strict";if("warp"===a.type){var b=parseInt(a.properties.row,10),c=parseInt(a.properties.col,10),d=dw.Direction.fromString(a.properties.dir);game.loadMap(a.properties.map,b,c,d)}}}}),dw.Hero.prototype.constructor=dw.Hero,dw.LoadingState=function(a){"use strict";dw._BaseState.apply(this,a),this.assetsLoaded=!1},dw.LoadingState.prototype=Object.create(dw._BaseState.prototype,{_createArmorArray:{value:function(a){"use strict";var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b.sort(function(a,b){return a.defense-b.defense}),b}},_createArmorMap:{value:function(a){"use strict";for(var b in a)a.hasOwnProperty(b)&&(a[b]=new dw.Armor(b,a[b]));return a}},_createShieldArray:{value:function(a){"use strict";var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b.sort(function(a,b){return a.defense-b.defense}),b}},_createShieldMap:{value:function(a){"use strict";for(var b in a)a.hasOwnProperty(b)&&(a[b]=new dw.Shield(b,a[b]));return a}},_createWeaponsArray:{value:function(a){"use strict";var b=[];for(var c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b.sort(function(a,b){return a.power-b.power}),b}},_createWeaponsMap:{value:function(a){"use strict";for(var b in a)a.hasOwnProperty(b)&&(a[b]=new dw.Weapon(b,a[b]));return a}},update:{value:function(a){"use strict";if(this.handleDefaultKeys(),!this.assetsLoaded){this.assetsLoaded=!0;var b=this.game,c=this;b.assets.addImage("title","res/title.png"),b.assets.addSpriteSheet("hero","res/hero.png",16,16,1,!0),b.assets.addSpriteSheet("npcs","res/npcs.png",16,16,1,!0),b.assets.addImage("battleBG","res/battle_backgrounds.png"),b.assets.addImage("font","res/font_8x10.png"),b.assets.addJson("enemies","res/enemies.json"),b.assets.addJson("enemyTerritories","res/enemyTerritories.json"),b.assets.addCanvas("enemiesImage","res/monsters.png"),b.assets.addJson("enemyAtlas","res/enemyAtlas.json"),b.assets.addJson("overworld.json","res/maps/overworld.json"),b.assets.addJson("equipment","res/equipment.json"),b.assets.addJson("brecconary.json","res/maps/brecconary.json"),b.assets.addJson("tantegelCastle.json","res/maps/tantegelCastle.json"),b.assets.addSound(dw.Sounds.MUSIC_TITLE_SCREEN,"res/sound/01 Dragon Quest 1 - Intro ~ Overture (22khz mono).ogg"),b.assets.addSound(dw.Sounds.MUSIC_TANTEGEL,"res/sound/02 Dragon Quest 1 - Tantegel Castle (22khz mono).ogg"),b.assets.addSound(dw.Sounds.MUSIC_TANTEGEL_LOWER,"res/sound/03 Dragon Quest 1 - Tantegel Castle (Lower) (22khz mono).ogg"),b.assets.addSound(dw.Sounds.MUSIC_TOWN,"res/sound/04 Dragon Quest 1 - Peaceful Village (22khz mono).ogg"),b.assets.addSound(dw.Sounds.MUSIC_OVERWORLD,"res/sound/05 Dragon Quest 1 - Kingdom of Alefgard (22khz mono).ogg"),b.assets.addSound(dw.Sounds.MUSIC_BATTLE,"res/sound/14 Dragon Quest 1 - A Monster Draws Near (16khz mono).ogg",2.32),b.assets.addSound("overnight","res/sound/21 Dragon Quest 1 - Special Item (22khz mono).ogg"),b.assets.addSound("victory","res/sound/25 Dragon Quest 1 - Victory (22khz mono).ogg",0,!1),b.assets.addSound("stairs","res/sound/29 Dragon Quest 1 - Stairs Up (22khz mono).wav"),b.assets.addSound("run","res/sound/30 Dragon Quest 1 - Stairs Down (22khz mono).wav"),b.assets.addSound("menu","res/sound/32 Dragon Quest 1 - Menu Button (22khz mono).wav"),b.assets.addSound("confirmation","res/sound/33 Dragon Quest 1 - Confirmation (22khz mono).wav"),b.assets.addSound("hit","res/sound/34 Dragon Quest 1 - Hit (22khz mono).wav"),b.assets.addSound("excellentMove","res/sound/35 Dragon Quest 1 - Excellent Move (22khz mono).wav"),b.assets.addSound("attack","res/sound/36 Dragon Quest 1 - Attack (22khz mono).ogg"),b.assets.addSound("receiveDamage","res/sound/37 Dragon Quest 1 - Receive Damage (22khz mono).wav"),b.assets.addSound("prepareToAttack","res/sound/39 Dragon Quest 1 - Prepare to Attack (22khz mono).wav"),b.assets.addSound("missed1","res/sound/40 Dragon Quest 1 - Missed! (22khz mono).wav"),b.assets.addSound("missed2","res/sound/41 Dragon Quest 1 - Missed! (2) (22khz mono).wav"),b.assets.addSound("bump","res/sound/42 Dragon Quest 1 - Bumping into Walls (22khz mono).wav"),b.assets.onLoad(function(){var a=b.assets.get("enemyAtlas"),d=new gtp.ImageAtlas({atlasInfo:a,canvas:b.assets.get("enemiesImage")}),e=d.parse();for(var f in e)e.hasOwnProperty(f)&&b.assets.set(f,e[f]);var g=b.assets.get("equipment"),h=c._createWeaponsMap(g.weapons);b.assets.set("weapons",h),b.assets.set("weaponsArray",c._createWeaponsArray(h));
var i=c._createArmorMap(g.armor);b.assets.set("armor",i),b.assets.set("armorArray",c._createArmorArray(i));var j=c._createShieldMap(g.shields);b.assets.set("shields",j),b.assets.set("shieldArray",c._createShieldArray(j));var k=b.assets.get("font");b.assets.set("font",new gtp.BitmapFont(k,16,20,16,12)),b.assets.addTmxMap(b.initLoadedMap("overworld.json")),b.assets.addTmxMap(b.initLoadedMap("brecconary.json")),b.assets.addTmxMap(b.initLoadedMap("tantegelCastle.json")),b.assets.onLoad(function(){var a=gtp.Utils.getRequestParam("skipTitle");null!==a?b.startNewGame():b.setState(new gtp.FadeOutInState(c,new dw.GameStudioAdvertState))})})}}},render:{value:function(a){"use strict";var b=this.game;b.clearScreen("rgb(0,0,255)");var c="Loading...";if(a.font="bold 30px Sans Serif",!this._textX){var d=a.measureText(c);this._textX=(b.getWidth()-d.width)/2;var e=4;this._textY=(b.getHeight()-e)/2}a.fillStyle="rgb(0, 0, 0)",a.fillText(c,this._textX,this._textY)}}}),dw.LoadingState.prototype.constructor=dw.LoadingState,dw.MapChangeState=function(){"use strict";gtp.FadeOutInState.apply(this,arguments)},dw.MapChangeState.prototype=Object.create(gtp.FadeOutInState.prototype,{init:{value:function(){"use strict";gtp.State.prototype.init.apply(this,arguments)}},_setState:{value:function(a){"use strict";game.getMapLogic().init(),gtp.FadeOutInState.prototype._setState.apply(this,arguments)}}}),dw.MapLogic=function(){},dw.MapLogic.prototype={init:function(){},npcText:function(a){}},dw.NpcType=Object.freeze({SOLDIER_GRAY:0,SOLDIER_RED:1,MAN_BLUE:2,WOMAN_BLUE:3,MERCHANT_GREEN:4,OLD_MAN_GRAY:5}),dw.Npc=function(a){"use strict";dw.RoamingEntity.call(this,a),gtp.Utils.mixin(a,this),this._origMapRow=this.mapRow,this._origMapCol=this.mapCol,this._origDir=this.direction,this.wanders&&(this._stepDelay=new gtp.Delay({millis:3e3,minDelta:-500,maxDelta:500}),delete this.wanders)},dw.Npc.prototype=Object.create(dw.RoamingEntity.prototype,{_computeColumn:{value:function(){"use strict";switch(this.direction){case dw.Direction.NORTH:return 4;case dw.Direction.EAST:return 2;default:case dw.Direction.SOUTH:return 0;case dw.Direction.WEST:return 6}}},update:{value:function(a){"use strict";this._stepDelay&&this._stepDelay.update(a)?(this._step(),this._stepDelay.reset()):this.handleIsMovingInUpdate()}},render:{value:function(a){"use strict";var b=game.assets.get("npcs"),c=this.type,d=this._computeColumn(),e=this.mapCol*game.getTileSize();e-=game.getMapXOffs(),e+=this.xOffs;var f=this.mapRow*game.getTileSize();f-=game.getMapYOffs(),f+=this.yOffs,d+=dw.Hero.STEP_INC,b.drawSprite(a,e,f,c,d)}},reset:{value:function(){"use strict";this.setMapLocation(this._origMapRow,this._origMapCol),this.direction=this._origDir,this._stepDelay&&this._stepDelay.reset()}},setNpcIndex:{value:function(a){"use strict";this.npcIndex=a}},_step:{value:function(){"use strict";for(var a,b=[this.tryToMoveUp,this.tryToMoveDown,this.tryToMoveRight,this.tryToMoveLeft];!a;){var c=gtp.Utils.randomInt(0,4);b[c].call(this),a=!0}}}}),dw.Npc.prototype.constructor=dw.Npc,dw.Shield=function(a,b){"use strict";this.name=a,this.baseCost=b.baseCost||0,this.defense=b.defense||1,this.displayName=b.displayName||this.name},dw.Shield.prototype={toString:function(){"use strict";return"[dw.Shield: name="+this.name+", baseCost="+this.baseCost+", defense="+this.defense+"]"}},dw.Shield.prototype.constructor=dw.Shield,dw.Sounds=Object.freeze({MUSIC_TITLE_SCREEN:"titleMusic",MUSIC_TANTEGEL:"tantegelMusic",MUSIC_TANTEGEL_LOWER:"tangelLowerMusic",MUSIC_OVERWORLD:"overworldMusic",MUSIC_BATTLE:"battleMusic",MUSIC_TOWN:"villageMusic"}),dw.TitleScreenState=function(){"use strict";dw._BaseState.apply(this,arguments),this.assetsLoaded=!1},dw.TitleScreenState.prototype=Object.create(dw._BaseState.prototype,{init:{value:function(){"use strict";dw._BaseState.prototype.init.apply(this,arguments),game.canvas.addEventListener("touchstart",this.handleStart,!1),this._delay=new gtp.Delay({millis:[600,400]}),this._blink=!0,game.audio.playMusic(dw.Sounds.MUSIC_TITLE_SCREEN)}},leaving:{value:function(a){"use strict";a.canvas.removeEventListener("touchstart",this.handleStart,!1)}},handleStart:{value:function(){"use strict";console.log("yee, touch detected!"),this._startGame()}},update:{value:function(a){"use strict";this.handleDefaultKeys(),this._delay.update(a)&&(this._delay.reset(),this._blink=!this._blink);var b=game.inputManager;b.enter()&&this._startGame()}},render:{value:function(a){"use strict";var b=this.game;b.clearScreen();var c=b.getWidth(),d=b.assets.get("title"),e=(c-d.width)/2,f=30;if(d.draw(a,e,f),!b.audio.isInitialized()){var g="Sound is disabled as your";e=(c-b.stringWidth(g))/2,f=390,b.drawString(g,e,f),g="browser does not support",e=(c-b.stringWidth(g))/2,f+=26,b.drawString(g,e,f),g="web audio",e=(c-b.stringWidth(g))/2,f+=26,b.drawString(g,e,f)}if(this._blink){var h="Press Enter";e=(c-b.stringWidth(h))/2,f=240,b.drawString(h,e,f)}}},_adjustGameMap:{value:function(){"use strict";for(var a=game.map,b=0;b<a.getLayerCount();b++){var c=a.getLayerByIndex(b);"tileLayer"!==c.name&&(c.visible=!1)}}},_startGame:{value:function(){"use strict";game.startNewGame()}}}),dw.TitleScreenState.prototype.constructor=dw.TitleScreenState,dw.GameStudioAdvertState=function(){"use strict";dw._BaseState.apply(this,arguments)},dw.GameStudioAdvertState.prototype=Object.create(dw._BaseState.prototype,{init:{value:function(){"use strict";dw._BaseState.prototype.init.apply(this,arguments),this._delay=new gtp.Delay({millis:3e3})}},update:{value:function(a){"use strict";this.handleDefaultKeys(),(this._delay.update(a)||game.anyKeyDown(!0))&&this._startGame()}},render:{value:function(a){"use strict";game.clearScreen();var b=game.getWidth(),c="OutOnBail Games Presents",d=(b-game.stringWidth(c))/2,e=(game.getHeight()-game.stringHeight())/2;game.drawString(c,d,e)}},_startGame:{value:function(){"use strict";game.setState(new gtp.FadeOutInState(this,new dw.TitleScreenState))}}}),dw.GameStudioAdvertState.prototype.constructor=dw.GameStudioAdvertState,dw.BattleTransitionState=function(a,b){"use strict";dw._BaseState.apply(this,arguments),this._enteringState=b,this._enteringStateScreenshot=b.createScreenshot()},dw.BattleTransitionState.prototype=Object.create(dw._BaseState.prototype,{_TICK_COUNT:{value:25},init:{value:function(){"use strict";gtp.State.prototype.init.apply(this,arguments),this.state=0,this.tick=0,game.audio.playMusic(dw.Sounds.MUSIC_BATTLE)}},render:{value:function(a){"use strict";game.drawMap(a),this._renderBattleBG(a)}},_renderBattleBG:{value:function(a){"use strict";var b=game.getWidth(),c=game.getHeight(),d=game.getTileSize(),e=b/2,f=c/2-d,g=game.assets.get("battleBG"),h=g.width/5,i=g.height/5,j=[e-2*h-h/2,e-h-h/2,e-h/2,e+h/2,e+h+h/2],k=[f-2*i-i/2,f-i-i/2,f-i/2,f+i/2,f+i+h/2];switch(this.state){case 25:a.drawImage(this._enteringStateScreenshot,j[0],k[0],j[4]+h-j[0],k[4]+i-k[0],j[0],k[0],j[4]+h-j[0],k[4]+i-k[0]);break;case 24:a.drawImage(this._enteringStateScreenshot,j[4],k[1],j[4]+h-j[4],k[2]-k[1],j[4],k[1],j[4]+h-j[4],k[2]-k[1]);case 23:a.drawImage(this._enteringStateScreenshot,j[4],k[2],j[4]+h-j[4],k[3]-k[2],j[4],k[2],j[4]+h-j[4],k[3]-k[2]);case 22:a.drawImage(this._enteringStateScreenshot,j[4],k[3],j[4]+h-j[4],k[4]-k[3],j[4],k[3],j[4]+h-j[4],k[4]-k[3]);case 21:a.drawImage(this._enteringStateScreenshot,j[4],k[4],j[4]+h-j[4],k[4]+i-k[4],j[4],k[4],j[4]+h-j[4],k[4]+i-k[4]);case 20:a.drawImage(this._enteringStateScreenshot,j[0],k[0],j[4]-j[0],k[4]+i-k[0],j[0],k[0],j[4]-j[0],k[4]+i-k[0]);break;case 19:a.drawImage(this._enteringStateScreenshot,j[2],k[4],j[3]-j[2],k[4]+i-k[4],j[2],k[4],j[3]-j[2],k[4]+i-k[4]);case 18:a.drawImage(this._enteringStateScreenshot,j[1],k[4],j[2]-j[1],k[4]+i-k[4],j[1],k[4],j[2]-j[1],k[4]+i-k[4]);case 17:a.drawImage(this._enteringStateScreenshot,j[0],k[4],j[1]-j[0],k[4]+i-k[4],j[0],k[4],j[1]-j[0],k[4]+i-k[4]);case 16:a.drawImage(this._enteringStateScreenshot,j[0],k[3],j[1]-j[0],k[4]-k[3],j[0],k[3],j[1]-j[0],k[4]-k[3]);case 15:a.drawImage(this._enteringStateScreenshot,j[0],k[2],j[1]-j[0],k[3]-k[2],j[0],k[2],j[1]-j[0],k[3]-k[2]);case 14:a.drawImage(this._enteringStateScreenshot,j[0],k[1],j[1]-j[0],k[2]-k[1],j[0],k[1],j[1]-j[0],k[2]-k[1]);case 13:a.drawImage(this._enteringStateScreenshot,j[0],k[0],j[1]-j[0],k[1]-k[0],j[0],k[0],j[1]-j[0],k[1]-k[0]);case 12:a.drawImage(this._enteringStateScreenshot,j[1],k[0],j[4]-j[1],k[4]-k[0],j[1],k[0],j[4]-j[1],k[4]-k[0]);break;case 11:a.drawImage(this._enteringStateScreenshot,j[2],k[0],j[3]-j[2],k[1]-k[0],j[2],k[0],j[3]-j[2],k[1]-k[0]);case 10:a.drawImage(this._enteringStateScreenshot,j[3],k[0],j[4]-j[3],k[1]-k[0],j[3],k[0],j[4]-j[3],k[1]-k[0]);case 9:a.drawImage(this._enteringStateScreenshot,j[1],k[1],j[4]-j[1],k[4]-k[1],j[1],k[1],j[4]-j[1],k[4]-k[1]);break;case 8:a.drawImage(this._enteringStateScreenshot,j[3],k[2],j[4]-j[3],k[3]-k[2],j[3],k[2],j[4]-j[3],k[3]-k[2]);case 7:a.drawImage(this._enteringStateScreenshot,j[3],k[3],j[4]-j[3],k[4]-k[3],j[3],k[3],j[4]-j[3],k[4]-k[3]);case 6:a.drawImage(this._enteringStateScreenshot,j[1],k[1],j[3]-j[1],k[4]-k[1],j[1],k[1],j[3]-j[1],k[4]-k[1]);break;case 5:a.drawImage(this._enteringStateScreenshot,j[1],k[3],j[2]-j[1],k[4]-k[3],j[1],k[3],j[2]-j[1],k[4]-k[3]);case 4:a.drawImage(this._enteringStateScreenshot,j[1],k[1],j[3]-j[1],k[3]-k[1],j[1],k[1],j[3]-j[1],k[3]-k[1]);break;case 3:a.drawImage(this._enteringStateScreenshot,j[1],k[1],j[2]-j[1],k[2]-k[1],j[1],k[1],j[2]-j[1],k[2]-k[1]);case 2:a.drawImage(this._enteringStateScreenshot,j[2],k[1],j[3]-j[2],k[3]-k[1],j[2],k[1],j[3]-j[2],k[3]-k[1]);break;case 1:a.drawImage(this._enteringStateScreenshot,j[2],k[2],j[3]-j[2],k[3]-k[2],j[2],k[2],j[3]-j[2],k[3]-k[2])}}},update:{value:function(a){"use strict";if(this.handleDefaultKeys(),0===this.tick)this.tick=game.getGameTime()+this._TICK_COUNT;else{var b=game.getGameTime();b>=this.tick&&(this.tick=b+this._TICK_COUNT,this.state++,25===this.state&&game.setState(this._enteringState))}}}}),dw.BattleTransitionState.prototype.constructor=dw.BattleTransitionState,dw.BattleState=function(a){"use strict";dw._BaseState.apply(this,arguments),this._enemyName=a},dw.BattleState.prototype=Object.create(dw._BaseState.prototype,{_backToRoaming:{value:function(){"use strict";game.audio.fadeOutMusic(dw.Sounds.MUSIC_OVERWORLD),game.setState(new dw.RoamingState)}},fight:{value:function(){"use strict";this._commandExecuting=!0,this._fightDelay=new gtp.Delay({millis:[300],callback:gtp.Utils.hitch(this,this._fightCallback)}),this._textBubble.addToConversation({text:"You attack!",sound:"attack"},!0)}},_fightCallback:{value:function(a){"use strict";game.audio.playSound("hit"),delete this._fightDelay,this._enemyFlashDelay=new gtp.Delay({millis:400,callback:gtp.Utils.hitch(this,this._enemyFlashCallback)}),this._flashMillis=0}},_enemyFlashCallback:{value:function(){"use strict";delete this._enemyFlashDelay;var a=game.hero.computePhysicalAttackDamage(this._enemy),b=this._enemy.takeDamage(a),c="Direct hit! Thy enemy's hit points have been reduced by "+a+".";this._textBubble.addToConversation({text:c},!0),b?this._defeatedEnemy():this._enemyAttack()}},_defeatedEnemy:{value:function(){"use strict";var a="\nThou hast defeated the "+this._enemy.name+".\nThy experience increases by "+this._enemy.xp+".\nThy gold increases by "+this._enemy.gp+".";this._enemiesDead=!0,game.hero.exp+=this._enemy.xp,game.party.gold+=this._enemy.gp,this._textBubble.addToConversation({text:a,music:"victory"}),this._commandExecuting=!1}},_enemyAttack:{value:function(){"use strict";console.log("_enemyAttack called");var a="The "+this._enemy.name+" attacks!";this._textBubble.addToConversation({text:a,sound:"prepareToAttack"},!0);var b=this;this._textBubble.onDone(function(){b._enemyAttackDelay=new gtp.Delay({millis:200,callback:gtp.Utils.hitch(b,b._enemyAttackCallback)})})}},_enemyAttackCallback:{value:function(){"use strict";delete this._enemyAttackDelay,this._shake=!0,game.audio.playSound("receiveDamage"),this._enemyAttackShakeDelay=new gtp.Delay({millis:1e3,callback:gtp.Utils.hitch(this,this._enemyAttackShakeCallback)})}},_enemyAttackShakeCallback:{value:function(){"use strict";delete this._enemyAttackShakeDelay,this._shake=!1;var a=this._enemy.ai(game.hero,this._enemy).damage;game.hero.takeDamage(a);var b="Thy hit points are reduced by "+a+".";game.hero.isDead()||(b+="\nCommand?"),this._textBubble.addToConversation({text:b},!0),this._commandExecuting=!1}},init:{value:function(){"use strict";gtp.State.prototype.init.apply(this,arguments),this._commandBubble=new dw.BattleCommandBubble,this._commandExecuting=!1,this._textBubble=new dw.TextBubble(game);var a=new dw.Conversation;this._enemy=new dw.Enemy(game.getEnemy(this._enemyName)).prepare(),a.addSegment({text:"A "+this._enemy.name+" draws near!  Command?"}),this._textBubble.setConversation(a),this._enemyAttackShake=0,this._statBubble=new dw.StatBubble}},item:{value:function(){"use strict";this._textBubble.addToConversation({text:"Not implemented, command?"})}},render:{value:function(a){"use strict";this._shake&&game.setCameraOffset(this._shakeXOffs,0),game.drawMap(a),this._shake&&game.setCameraOffset(0,0);var b=game.getWidth(),c=game.getHeight(),d=game.getTileSize(),e=game.assets.get("battleBG"),f=(b-e.width)/2,g=(c-e.height)/2-d;if(e.draw(a,f,g),this._enemy&&!this._enemiesDead){var h=Math.round(this._flashMillis)%40>20,i=this._enemy.getImage(h);f=(b-i.width)/2,g+=e.height-d/2-i.height,i.draw(a,f,g),this._commandExecuting||this._textBubble&&this._textBubble.isDone()&&this._commandBubble.paint(a),this._statBubble&&this._statBubble.paint(a),this._textBubble&&this._textBubble.paint(a)}else this._enemiesDead&&(this._statBubble&&this._statBubble.paint(a),this._textBubble&&this._textBubble.paint(a))}},run:{value:function(){"use strict";this._commandExecuting=!0,this._fightDelay=new gtp.Delay({millis:[600],callback:gtp.Utils.hitch(this,this._runCallback)}),game.audio.playSound("run"),this._textBubble.addToConversation({text:game.hero.name+" started to run away."},!0)}},_runCallback:{value:function(a){"use strict";delete this._fightDelay;var b=gtp.Utils.randomInt(2),c=1===b;c?(this._commandExecuting=!1,this._backToRoaming()):(this._commandExecuting=!1,this._commandBubble.reset(),this._textBubble.addToConversation({text:"Couldn't run!"}))}},update:{value:function(a){"use strict";return this.handleDefaultKeys(),this._enemiesDead&&this._textBubble.isDone()&&game.anyKeyDown()?void this._backToRoaming():(this._fightDelay&&this._fightDelay.update(a),this._enemyFlashDelay?(this._flashMillis+=a,this._enemyFlashDelay.update(a)):this._enemyAttackDelay?this._enemyAttackDelay.update(a):this._enemyAttackShakeDelay&&(this._enemyAttackShakeDelay.update(a),this._shakeMillisCount||(this._shakeMillisCount=0),this._shakeMillisCount+=a,this._shakeXOffs=this._shakeMillisCount%100>50?4:-4,console.log(a)),void(this._textBubble.isDone()?!this._commandExecuting&&this._commandBubble.handleInput()&&this._commandBubble.handleCommandChosen(this):(this._textBubble.handleInput(),this._textBubble.update(a))))}}}),dw.BattleState.prototype.constructor=dw.BattleState;var _RoamingSubState=Object.freeze({ROAMING:0,MENU:1,TALKING:2,OVERNIGHT:3});dw.RoamingState=function(){"use strict";dw._BaseState.apply(this,arguments),this._substate=_RoamingSubState.ROAMING,this._updateMethods={},this._updateMethods[_RoamingSubState.ROAMING]=this._updateRoaming,this._updateMethods[_RoamingSubState.MENU]=this._updateMenu,this._updateMethods[_RoamingSubState.TALKING]=this._updateTalking,this._updateMethods[_RoamingSubState.OVERNIGHT]=this._updateOvernight,this._textBubble=new dw.TextBubble(game),this._showTextBubble=!1,this._commandBubble=new dw.CommandBubble,this._statBubble=new dw.StatBubble,this._stationaryTimer=new gtp.Delay({millis:1e3})},dw.RoamingState.prototype=Object.create(dw._BaseState.prototype,{_OVERNIGHT_DARK_TIME:{value:2500,writable:!1},_OVERNIGHT_FADE_TIME:{value:500,writable:!1},_totalTime:{value:0,writable:!0},update:{value:function(a){"use strict";return this.handleDefaultKeys(),game.inputManager.isKeyDown(gtp.Keys.R,!0)?void game.startRandomEncounter():(game.inputManager.isKeyDown(gtp.Keys.O,!0)&&(this._substate=_RoamingSubState.OVERNIGHT),game.hero.update(a),dw.RoamingState._totalTime+=a,dw.RoamingState._totalTime>=1e3&&(dw.RoamingState._totalTime=0),void this._updateMethods[this._substate].call(this,a))}},_updateMenu:{value:function(a){"use strict";if(this._statusBubble&&game.anyKeyDown())return void delete this._statusBubble;if(this._itemBubble)return void(game.anyKeyDown()&&delete this._itemBubble);var b=this._commandBubble.handleInput();return b?void this._commandBubble.handleCommandChosen(this):void 0}},_updateRoaming:{value:function(a){"use strict";var b=game.hero,c=game.inputManager;return game.actionKeyPressed()?(game.setNpcsPaused(!0),this._commandBubble.reset(),game.audio.playSound("menu"),void(this._substate=_RoamingSubState.MENU)):(b.isMoving()||game.state!==this||(c.up()?(b.tryToMoveUp(),this._stationaryTimer.reset()):c.down()?(b.tryToMoveDown(),this._stationaryTimer.reset()):c.left()?(b.tryToMoveLeft(),this._stationaryTimer.reset()):c.right()&&(b.tryToMoveRight(),this._stationaryTimer.reset())),this._showStats=this._stationaryTimer.update(a),c.isKeyDown(gtp.Keys.SHIFT)&&(c.isKeyDown(gtp.Keys.C,!0)&&game.toggleShowCollisionLayer(),c.isKeyDown(gtp.Keys.T,!0)&&game.toggleShowTerritoryLayer(),c.isKeyDown(gtp.Keys.S,!0)&&game.audio.playSound("stairs")),void game.map.npcs.forEach(function(b){b.update(a)}))}},_updateTalking:{value:function(a){"use strict";var b=this._textBubble.handleInput();return this._textBubble.isOvernight()?(this._substate=_RoamingSubState.OVERNIGHT,this._textBubble.clearOvernight()):this._showTextBubble&&this._textBubble.update(a),b?void this.startRoaming():void 0}},_updateOvernight:{value:function(a){"use strict";this._overnightDelay?this._overnightDelay.update(a):(game.audio.playMusic("overnight",!1),this._overnightDelay=new gtp.Delay({millis:[this._OVERNIGHT_DARK_TIME],callback:gtp.Utils.hitch(this,this._overnightOver)}))}},_overnightOver:{value:function(){"use strict";game.audio.playMusic(dw.Sounds.MUSIC_TOWN),delete this._overnightDelay,this._substate=_RoamingSubState.TALKING}},render:{value:function(a){"use strict";if(game.drawMap(a),game.hero.render(a),game.map.npcs.forEach(function(b){b.render(a)}),this._substate===_RoamingSubState.MENU&&this._commandBubble.paint(a),this._showTextBubble&&this._textBubble.paint(a),(this._substate!==_RoamingSubState.ROAMING||this._showStats)&&this._statBubble.paint(a),this._statusBubble&&this._statusBubble.paint(a),this._itemBubble&&this._itemBubble.paint(a),this._overnightDelay){a.save();var b,c=this._overnightDelay.getRemaining(),d=this._OVERNIGHT_FADE_TIME;c>this._OVERNIGHT_DARK_TIME-d?(b=(this._OVERNIGHT_DARK_TIME-c)/d,a.fillStyle="rgba(0, 0, 0, "+b+")"):d>c?(b=c/d,a.fillStyle="rgba(0, 0, 0, "+b+")"):a.fillStyle="rgba(0, 0, 0, 1)",a.fillRect(0,0,game.getWidth(),game.getHeight()),a.restore()}}},showInventory:{value:function(){"use strict";this._itemBubble=new dw.ItemBubble}},showStatus:{value:function(){"use strict";this._statusBubble=new dw.StatusBubble}},startRoaming:{value:function(){"use strict";game.setNpcsPaused(!1),this._showTextBubble=!1,this._substate=_RoamingSubState.ROAMING,this._stationaryTimer.reset()}},talkToNpc:{value:function(){"use strict";var a=game.getMapLogic();if(!a)return void console.log("Error: No map logic found for this map!  Cannot talk to NPCs!");var b=new dw.Conversation,c=game.getNpcHeroIsFacing();if(c){var d=game.hero,e=(d.direction+2)%4;c.direction=e,b.setSegments(a.npcText(c))}else b.addSegment("There is nobody in that direction!");this._showTextBubble=!0,this._textBubble.setConversation(b),this._substate=_RoamingSubState.TALKING}}}),dw.RoamingState.prototype.constructor=dw.RoamingState,dw.Conversation=function(){"use strict";this._segments=[],this._responses=[]},dw.Conversation.DONE="_done",dw.Conversation.CHOICES_SEGMENT="choicesSegment",dw.Conversation.NOT_ENOUGH_SEGMENT="notEnoughGold",dw.Conversation.CONFIRM_SEGMENT="confirmPurchase",dw.Conversation.PURCHASE_SEGMENT="makePurchase",dw.Conversation.SOMETHING_ELSE_SEGMENT="somethingElse",dw.Conversation.BID_FAREWELL_SEGMENT="bidFarewell",dw.Conversation.prototype=function(){"use strict";return{addSegment:function(a,b){a.length&&(a={text:a});var c=new dw.ConversationSegment(this,a);b?this._segments.splice(this._segmentIndex,0,c):this._segments.push(c)},setSegments:function(a){if(a.conversationType)switch(a.conversationType){case"merchant":if(!a.choices)throw"No choices specified in conversation: "+JSON.stringify(a);this.setSegments(merchantConversationTemplate(this,a));break;case"innkeeper":if(!a.cost)throw"No cost for the inn specified in conversation: "+JSON.stringify(a);this.setSegments(innkeeperConversationTemplate(this,a));break;default:throw"Unknown conversation type: "+a.conversationType}else if(Array.isArray(a)){var b=this;a.forEach(function(a){b.addSegment(a)})}else this.addSegment(a)},start:function(){return this._segmentIndex=0,this._segments[0]},_findIndexById:function(a){for(var b=0;b<this._segments.length;b++)if(this._segments[b].id===a)return b;return this._segments.length},_getNextIndex:function(){var a=this.current();return a?a.next?a.next===dw.Conversation.DONE?this._segments.length:this._findIndexById(a.next):this._segmentIndex+1:this._segments.length},hasNext:function(){return this._getNextIndex()<this._segments.length},current:function(a){var b=this._segmentIndex>=this._segments.length?null:this._segments[this._segmentIndex];return a&&b&&b.action&&b.action(),b},next:function(a){var b=this._getNextIndex();if(b<this._segments.length){this._segmentIndex=b;var c=this._segments[this._segmentIndex];return a&&c&&c.action&&c.action(),c}return null},peekNext:function(){var a=this._getNextIndex();return a<this._segments.length?this._segments[a]:null},setDialogueState:function(a){a||(this._segmentIndex=this._segments.length);var b=this._findIndexById(a);return b<this._segments.length?(this._segmentIndex=b,void console.log('Set dialogue state to "'+a+'" ('+b+")")):(console.error('Unknown next dialogue state: "'+a+'"'),this._segmentIndex=this._segments.length,this._segmentIndex)},setItem:function(a){this.item=a}}}(),dw.ConversationSegment=function(a,b){"use strict";this.parentConversation=a,gtp.Utils.mixin(b,this)},dw.ConversationSegment.prototype={_getParameterizedText:function(){"use strict";for(var a=this.text,b=a.indexOf("\\w{");b>-1;){var c=a.indexOf("}",b+3);if(c>-1){var d=a.substring(b+3,c);switch(d){case"hero.name":a=a.substring(0,b)+game.hero.name+a.substring(c+1),b=a.indexOf("\\w{",b+game.hero.name.length);break;case"item.name":var e=this.parentConversation.item.displayName;a=a.substring(0,b)+e+a.substring(c+1),b=a.indexOf("\\w{",b+e.length);break;case"item.baseCost":a=a.substring(0,b)+this.parentConversation.item.baseCost+a.substring(c+1),b=a.indexOf("\\w{",b+this.parentConversation.item.baseCost.toString().length);break;default:console.error("Unknown token in NPC text: "+d),b=-1}}}return a},currentText:function(){"use strict";return this._getParameterizedText(this.text,this)}},dw.ConversationSegment.prototype.constructor=dw.ConversationSegment,dw.ShoppingBubble=function(a,b){"use strict";var c=a.getTileSize(),d=5*c,e=1*c,f=9*c,g=6*c;dw.Bubble.call(this,null,d,e,f,g),this._choices=b.choices.map(function(b){return a.getWeapon(b)||a.getArmor(b)||a.getShield(b)}),this._curChoice=0},dw.ShoppingBubble.prototype=Object.create(dw.Bubble.prototype,{handleInput:{value:function(){"use strict";if(game.cancelKeyPressed())this._curChoice=0;else if(game.actionKeyPressed())return this._done=!0,!0;return!1}},update:{value:function(a){"use strict";var b=game.inputManager;b.up(!0)?this._curChoice=Math.max(0,this._curChoice-1):b.down(!0)&&(this._curChoice=Math.min(this._curChoice+1,this._choices.length-1))}},paintContent:{value:function(a,b){"use strict";var c=this.x+dw.Bubble.MARGIN+10*game._scale;a.fillStyle="rgb(255,255,255)";for(var d=0;d<this._choices.length;d++)this._curChoice===d&&game.drawArrow(this.x+dw.Bubble.MARGIN,b),game.drawString(this._choices[d].displayName,c,b),b+=10*game._scale}},getSelectedItem:{value:function(){"use strict";return-1===this._curChoice?null:this._choices[this._curChoice]}},setChoices:{value:function(a){"use strict";this._choices=a}}}),dw.ShoppingBubble.prototype.constructor=dw.ShoppingBubble,Brecconary.prototype=function(){"use strict";var a={greeter:function(a){return"Thou art most welcome in Brecconary."},oldman1:function(a){return"Watch thy Hit Points when in the Poisonous Marsh."},woman_at_shop:function(a){return"Welcome!\nEnter the shop and speak to its keeper across the desk."},soldier1:function(a){return["Many have been the warriors who have perished on this quest.","But for thee I wish success, \\w{hero.name}."]},oldman_test:function(a){return a.hero.getStrength()<100?["Brave traveler, you must save us from the dreaded Dragon Lord!!","But you should buy some supplies before venturing out...",{id:"makeUserChoose",clear:!1,text:"Do you want my help?",afterSound:"confirmation",choices:[{text:"Yes",next:function(){return a.party.addGold(10),"iGaveYouMoney"}},{text:"Nope",next:"makeUserChoose"}]},{id:"iGaveYouMoney",text:"I've given you all I have... 100 gold.  Good luck, my child."}]:"Wow, you are strong! I cannot help you.  Go, defeat the Dragon Lord!"},innkeeper:function(a){return{conversationType:"innkeeper",cost:6}},merchant1:function(a){return{conversationType:"merchant",choices:["bambooPole","club","copperSword"],introText:"We deal in weapons and armor.\nDost thou wish to buy anything today?"}}};return Object.create(dw.MapLogic.prototype,{init:{value:function(){}},npcText:{value:function(b){console.log("Talking to: "+JSON.stringify(b));var c=a[b.name];return c?c(game):"I have nothing to say..."}}})}(),Brecconary.prototype.constructor=Brecconary,Overworld.prototype=function(){"use strict";var a={npc:function(a){return["I speak with... \\ddelays...","Did you notice that?"]}};return Object.create(dw.MapLogic.prototype,{init:{value:function(){}},npcText:{value:function(b){console.log("Talking to: "+JSON.stringify(b));var c=a[b.name];return c?c(game):"I have nothing to say..."}}})}(),Overworld.prototype.constructor=Overworld,TantegelCastle.prototype=function(){"use strict";var a={south_soldier_left:function(a){return"Welcome to Tantegel Castle!"},south_soldier_right:function(a){return"Zzz..."},bottom_left_merchant_1:function(a){return"I'm merchant 1"},bottom_left_merchant_2:function(a){return"I'm merchant 2"},bottom_left_merchant_3:function(a){return"I'm merchant 3"},bottom_right_soldier:function(a){return"I am not sure what to say..."},bottom_right_old_man:function(a){return"I am not sure what to say either..."},stairs_soldier_north:function(a){return"Up these stairs resides the king."},stairs_soldier_south:function(a){return"I go on break in 15 minutes."},woman_near_stairs:function(a){return"I do not have my text to say yet."},man_near_stairs:function(a){return"I do not have my text to say yet either."},treasure_room_soldier:function(a){return"How did you get in here???"},man_in_west_room:function(a){return"I am not sure what to say..."},top_right_soldier:function(a){return"You are in Tantegel Castle."},outside_merchant:function(a){return"I have nothing to sell right now!"},outside_woman:function(a){return"What are you doing out here?"},prison_guard_soldier:function(a){return"This is the prison."},old_man_east:function(a){return"Leave me alone, I'm old!"},prisoner_red_soldier:function(a){return"I was arrested for being a peeping tom."},king_soldier_right:function(a){return"???"},king_soldier_left:function(a){return"???"},king_soldier_wandering:function(a){return"???"}};return Object.create(dw.MapLogic.prototype,{init:{value:function(){}},npcText:{value:function(b){console.log("Talking to: "+JSON.stringify(b));var c=a[b.name];return c?c(game):"I have nothing to say..."}}})}(),TantegelCastle.prototype.constructor=TantegelCastle;